<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crow Syndicate - PokeMMO Team</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-image: url('images/background-sky.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .discord-btn { background-color: #5865F2; transition: background-color 0.3s ease; }
        .discord-btn:hover { background-color: #4752C4; }
        .loader { border-top-color: #5865F2; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .circular-container { position: relative; width: 350px; height: 350px; display: flex; justify-content: center; align-items: center; border-radius: 50%; }
        .center-logo { width: 140px; height: 140px; background-color: rgba(31, 41, 55, 0.8); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 4px solid #4b5563; z-index: 10; }
        .center-logo img { width: 100px; height: 100px; }

        .icon-item {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transform: rotate(calc(360deg / 10 * var(--i))); /* For 10 icons */
            pointer-events: none;
        }
        .icon-item a {
            position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%) rotate(0deg) translateY(-175px);
            width: 60px; height: 60px; background: #2b3748; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #9ca3af; font-size: 1.5rem; border: 2px solid #4b5563;
            cursor: pointer; transition: all 0.3s ease; pointer-events: auto;
        }
        .icon-item a .fa-solid { transform: rotate(calc(-360deg / 10 * var(--i))); transition: transform 0.3s ease; }
        .icon-item a:hover { background-color: #5865F2; color: #fff; border-color: #5865F2; box-shadow: 0 0 15px #5865F2; }
        .icon-item a:hover .fa-solid { transform: rotate(calc(-360deg / 10 * var(--i))) scale(1.2); }
        
        #flying-crows-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; overflow: hidden; z-index: 1; }
        .flying-crow {
            position: absolute; width: 200px; height: 176px;
            animation: fly-across linear infinite backwards; opacity: 0;
        }
        @keyframes fly-across {
            0% { transform: translateX(100vw); opacity: 0; } 5% { opacity: 1; }
            95% { opacity: 1; } 100% { transform: translateX(-200px); opacity: 0; }
        }
        
        .fullscreen-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.95); backdrop-filter: blur(10px); overflow-y: auto; z-index: 50; }
        .content-grid { display: grid; gap: 1.5rem; }
        .dex-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        .shiny-hall-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
        .dex-entry { background-color: #374151; border-radius: 0.5rem; padding: 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .dex-entry:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); border-color: #5865F2; }
        .dex-entry.pending { border-color: #FBBF24; }
        .dex-entry.captured, .dex-entry.pending { cursor: not-allowed; }
        .dex-entry img.sprite { width: 96px; height: 96px; margin: 0 auto; transition: filter 0.3s ease; filter: brightness(0); }
        .dex-entry.captured img.sprite { filter: brightness(1); }
        .dex-entry.pending img.sprite { filter: brightness(1) grayscale(50%); }

        .hall-entry { background-color: #374151; border-radius: 0.75rem; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
        .hall-entry .pokemon-sprite { width: 128px; height: 128px; }
        .hall-entry .character-image { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #4b5563; margin-top: -40px; background-color: #374151; }
        .verification-card { background-color: #1F2937; border-radius: 0.5rem; padding: 1rem; border-left: 4px solid #FBBF24; }
        .tab-btn { background-color: #374151; }
        .tab-btn.active { background-color: #5865F2; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="flying-crows-container"></div>
    <div id="app" class="w-full max-w-5xl mx-auto" style="position: relative; z-index: 5;">
        <div id="loading" class="text-center">
             <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
             <p class="text-lg text-gray-400">Loading your PokeMMO Hub...</p>
        </div>
        <div id="landing-view" class="hidden flex-col items-center text-center">
             <div class="circular-container mb-12">
                <div class="center-logo"><img src="images/crow.png" alt="Crow Syndicate Logo"></div>
                <div class="icon-item" style="--i: 0;"><a data-page="shiny-dex" data-tooltip="Shiny Dex"><i class="fa-solid fa-wand-magic-sparkles"></i></a></div>
                <div class="icon-item" style="--i: 1;"><a data-page="about-us" data-tooltip="About Us"><i class="fa-solid fa-circle-info"></i></a></div>
                <div class="icon-item" style="--i: 2;"><a data-page="members" data-tooltip="Members"><i class="fa-solid fa-users"></i></a></div>
                <div class="icon-item" style="--i: 3;"><a data-page="recruitment" data-tooltip="Recruitment"><i class="fa-solid fa-user-plus"></i></a></div>
                <div class="icon-item" style="--i: 4;"><a data-page="shiny-hall" data-tooltip="Shiny Hall"><i class="fa-solid fa-star"></i></a></div>
                <div class="icon-item" style="--i: 5;"><a data-page="tournaments" data-tooltip="Tournaments"><i class="fa-solid fa-trophy"></i></a></div>
                <div class="icon-item" style="--i: 6;"><a data-page="bounties" data-tooltip="Bounties"><i class="fa-solid fa-crosshairs"></i></a></div>
                <div class="icon-item" style="--i: 7;"><a data-page="gallery" data-tooltip="Gallery"><i class="fa-solid fa-images"></i></a></div>
                <div id="verification-panel-icon" class="icon-item hidden" style="--i: 8;"><a data-page="verification-panel" data-tooltip="Verifications"><i class="fa-solid fa-shield-halved"></i></a></div>
                <div id="sitemaster-panel-icon" class="icon-item hidden" style="--i: 9;"><a data-page="sitemaster-panel" data-tooltip="Site Master"><i class="fa-solid fa-crown"></i></a></div>
             </div>
             <h1 class="text-6xl font-bold text-white drop-shadow-lg" style="text-shadow: 2px 2px 4px #000;">Crow Syndicate</h1>
             <p class="text-gray-200 mb-8 max-w-md bg-black bg-opacity-50 p-2 rounded-md">A PokeMMO team focused on competitive play, community, and strategy.</p>
             <div id="auth-buttons"></div>
        </div>
    </div>

    <!-- Fullscreen Pages -->
    <div id="shiny-dex-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
            <h1 class="text-3xl font-bold text-center">Shiny Dex</h1>
            <div id="dex-counter" class="w-24 text-right text-lg text-gray-400 font-semibold">0 / 0</div>
        </header><main id="dex-grid" class="content-grid dex-grid"></main>
    </div>
    <div id="shiny-hall-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
            <h1 class="text-3xl font-bold text-center">Shiny Hall of Fame</h1><div class="w-24"></div>
        </header><main id="shiny-hall-grid" class="content-grid shiny-hall-grid"></main>
    </div>
    <div id="verification-panel-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
            <h1 class="text-3xl font-bold text-center">Verification Panel</h1><div class="w-24"></div>
        </header>
        <main><h2 class="text-2xl font-semibold mb-4">Pending Shiny Verifications</h2><div id="verification-queue" class="space-y-4"></div></main>
    </div>
    <div id="sitemaster-panel-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
            <h1 class="text-3xl font-bold text-center">Site Master Panel</h1><div class="w-24"></div>
        </header>
        <main>
            <div class="flex border-b border-gray-700 mb-6"><div class="tabs">
                <button class="tab-btn py-2 px-4 rounded-t-lg active" data-tab="ranks">Manage Ranks</button>
                <button class="tab-btn py-2 px-4 rounded-t-lg" data-tab="users">Manage Users</button>
            </div></div>
            <div id="ranks-tab" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4">Ranks</h2>
                <div id="ranks-list" class="space-y-4"></div>
                <form id="rank-form" class="mt-8 bg-gray-800 p-4 rounded-lg"><h3 class="text-xl font-bold mb-4">Create/Edit Rank</h3>
                    <input type="hidden" id="rank-id"><input type="text" id="rank-name" placeholder="Rank Name" class="w-full bg-gray-700 p-2 rounded-md mb-4" required>
                    <div id="permissions-container" class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4"></div>
                    <button type="submit" class="discord-btn py-2 px-4 rounded-lg">Save Rank</button>
                    <button type="button" id="clear-rank-form" class="bg-gray-600 py-2 px-4 rounded-lg ml-2">Clear</button>
                </form>
            </div>
            <div id="users-tab" class="tab-content hidden"><h2 class="text-2xl font-semibold mb-4">Assign Ranks</h2>
                <div class="flex gap-4"><input type="text" id="user-search" placeholder="Search by Discord Username" class="flex-grow bg-gray-700 p-2 rounded-md"></div>
                <div id="user-list" class="mt-4 space-y-2"></div>
            </div>
        </main>
    </div>
    
    <div id="verification-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60]">
        <div class="bg-gray-800 rounded-lg p-8 w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="verify-pokemon-name" class="text-2xl font-bold">Verify Shiny Capture</h2>
                 <img id="verify-pokemon-sprite" src="" class="w-16 h-16">
            </div>
            <p class="text-gray-400 mb-6">Submit the details of your capture for verification by staff.</p>
            <form id="verification-form">
                <input type="hidden" id="verify-pokemon-id">
                <div class="mb-4">
                    <label for="verify-discord-user" class="block text-sm font-medium text-gray-300 mb-1">Discord Username</label>
                    <input type="text" id="verify-discord-user" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" readonly>
                </div>
                <div class="mb-4">
                    <label for="verify-ingame-name" class="block text-sm font-medium text-gray-300 mb-1">In-game Name</label>
                    <input type="text" id="verify-ingame-name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" required>
                </div>
                 <div class="mb-4">
                    <label for="verify-character-image" class="block text-sm font-medium text-gray-300 mb-1">Character Image Filename</label>
                    <input type="text" id="verify-character-image" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" placeholder="e.g., your-name.png" required>
                    <p class="text-xs text-gray-500 mt-1">Upload image to 'images/characters' in the repo and enter the filename.</p>
                </div>
                <div class="mb-4">
                    <label for="verify-date" class="block text-sm font-medium text-gray-300 mb-1">Date Captured</label>
                    <input type="date" id="verify-date" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" required>
                </div>
                <div class="mb-4">
                    <label for="verify-encounters" class="block text-sm font-medium text-gray-300 mb-1">Encounters (Optional)</label>
                    <input type="number" id="verify-encounters" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" min="0">
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-verification-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="discord-btn text-white font-bold py-2 px-4 rounded-lg">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, addDoc, serverTimestamp, deleteDoc, writeBatch, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "##FIREBASE_API_KEY##", authDomain: "##FIREBASE_AUTH_DOMAIN##", projectId: "##FIREBASE_PROJECT_ID##", storageBucket: "##FIREBASE_STORAGE_BUCKET##", messagingSenderId: "##FIREBASE_MESSAGING_SENDER_ID##", appId: "##FIREBASE_APP_ID##" };
        const DISCORD_CLIENT_ID = "##DISCORD_CLIENT_ID##"; 
        const POKEMON_COUNT = 649;
        const ALL_PERMISSIONS = ['can_verify_shinies', 'can_manage_recruitment', 'can_edit_pages', 'can_manage_bounties'];

        // --- STATE ---
        let currentUser = null, discordUser = null, isSiteMaster = false, userPermissions = new Set();
        let pokemonData = [], allRanks = [], allUsers = [];
        let userDexData = new Set(), userPendingData = new Set();
        let isDexLoaded = false, isHallLoaded = false, isStaffPanelLoaded = false, isMasterPanelLoaded = false;
        
        // --- UI ELEMENTS ---
        const appViews = { loading: document.getElementById('loading'), landing: document.getElementById('landing-view'), shinyDex: document.getElementById('shiny-dex-view'), shinyHall: document.getElementById('shiny-hall-view'), verificationPanel: document.getElementById('verification-panel-view'), siteMasterPanel: document.getElementById('sitemaster-panel-view') };
        const verificationPanelIcon = document.getElementById('verification-panel-icon'), sitemasterPanelIcon = document.getElementById('sitemaster-panel-icon');
        const authButtonsContainer = document.getElementById('auth-buttons'), backBtns = document.querySelectorAll('.back-btn');
        const iconLinks = document.querySelectorAll('.icon-item a');
        const dexGridEl = document.getElementById('dex-grid'), verificationQueueEl = document.getElementById('verification-queue');
        const rankForm = document.getElementById('rank-form'), ranksListEl = document.getElementById('ranks-list');
        const userSearchInput = document.getElementById('user-search'), userListEl = document.getElementById('user-list');
        const verificationModal = document.getElementById('verification-modal'), verificationForm = document.getElementById('verification-form');
        const cancelVerificationBtn = document.getElementById('cancel-verification-btn');
        const verifyPokemonIdInput = document.getElementById('verify-pokemon-id'), verifyPokemonNameEl = document.getElementById('verify-pokemon-name');
        const verifyPokemonSpriteEl = document.getElementById('verify-pokemon-sprite'), verifyDiscordUserInput = document.getElementById('verify-discord-user');

        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Firebase init failed.", e); }
        
        function showView(viewName) {
            document.body.style.overflow = ['shinyDex', 'shinyHall', 'verificationPanel', 'siteMasterPanel'].includes(viewName) ? 'auto' : 'hidden';
            Object.values(appViews).forEach(v => v.classList.add('hidden'));
            if (appViews[viewName]) {
                appViews[viewName].classList.remove('hidden');
                if (viewName === 'landing') appViews[viewName].classList.add('flex');
            }
        }

        async function initializeAppLogic() {
            if (!auth) return;
            const siteMasterRef = doc(db, 'config', 'sitemaster');
            const siteMasterSnap = await getDoc(siteMasterRef);

            if (!siteMasterSnap.exists()) {
                renderClaimSiteState();
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const discordToken = getDiscordToken();
                        if (discordToken) {
                            showView('loading');
                            try {
                                const claimingUser = await fetchDiscordUser(discordToken);
                                await setDoc(siteMasterRef, { members: [claimingUser.id] });
                                window.location.reload();
                            } catch (error) { console.error("Failed to claim site:", error); clearSession(true); }
                        }
                    } else { signInAnonymously(auth).catch(console.error); }
                });
            } else {
                onAuthStateChanged(auth, async (user) => {
                    currentUser = user;
                    if (user) {
                        const discordToken = getDiscordToken();
                        if (discordToken) {
                            showView('landing');
                            try {
                                discordUser = await fetchDiscordUser(discordToken);
                                await Promise.all([saveUserToFirestore(user.uid, discordUser), loadUserRankAndPermissions(discordUser.id)]);
                                renderAuthButtons();
                                loadUserDexData();
                                loadPendingVerifications();
                            } catch (error) { console.error("Login flow error:", error); clearSession(true); }
                        } else { renderLoggedOutState(); }
                    } else { signInAnonymously(auth).catch(console.error); }
                });
            }
        }
        
        function handleLogin() { window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&response_type=token&scope=identify`; }
        function getDiscordToken() {
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            const token = fragment.get('access_token');
            if (token) { localStorage.setItem('discord_token', token); window.history.replaceState({}, '', window.location.pathname); return token; }
            return localStorage.getItem('discord_token');
        }
        async function fetchDiscordUser(token) {
            const r = await fetch('https://discord.com/api/users/@me', { headers: { authorization: `Bearer ${token}` } });
            if (!r.ok) throw new Error(`Discord API Error: ${r.status}`);
            return await r.json();
        }
        async function saveUserToFirestore(uid, dUser) { await setDoc(doc(db, 'users', uid), { discordId: dUser.id, username: dUser.username, avatar: dUser.avatar }, { merge: true }); }
        async function loadUserRankAndPermissions(discordId) {
            const masterSnap = await getDoc(doc(db, 'config', 'sitemaster'));
            if (masterSnap.exists() && masterSnap.data().members.includes(discordId)) {
                isSiteMaster = true;
                sitemasterPanelIcon.classList.remove('hidden');
            }
            if (!currentUser) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            const userSnap = await getDoc(userDocRef);
            if (userSnap.exists()) {
                const userData = userSnap.data();
                if (userData.rankId) {
                    const rankSnap = await getDoc(doc(db, 'ranks', userData.rankId));
                    if (rankSnap.exists()) {
                        userPermissions = new Set(rankSnap.data().permissions || []);
                        if (userPermissions.has('can_verify_shinies')) verificationPanelIcon.classList.remove('hidden');
                    }
                }
            }
        }

        function clearSession(isError = false) {
            localStorage.removeItem('discord_token');
            discordUser = null; isSiteMaster = false; userPermissions.clear();
            if (!isError) window.location.href = window.location.pathname;
            else renderLoggedOutState();
        }

        async function showPage(page) {
            const handlers = {
                'shiny-dex': async () => { if (!isDexLoaded) await fetchPokemonData(); renderDexGrid(); showView('shinyDex'); },
                'shiny-hall': async () => { if (!isHallLoaded) await fetchPokemonData(); await loadAndRenderShinyHall(); showView('shinyHall'); },
                'verification-panel': async () => { if (userPermissions.has('can_verify_shinies') || isSiteMaster) { if(!isStaffPanelLoaded) await fetchPokemonData(); await loadAndRenderVerificationQueue(); showView('verification-panel-view'); } },
                'sitemaster-panel': async () => { if (isSiteMaster) { if(!isMasterPanelLoaded) await loadSiteMasterPanel(); showView('sitemaster-panel-view'); } },
                'members': () => { if (discordUser) showView('dashboard'); else handleLogin(); }
            };
            if(handlers[page]) handlers[page]();
        }

        async function fetchPokemonData() { if (pokemonData.length > 0) return; try { const r = await fetch(`https://pokeapi.co/api/v2/pokemon?limit=${POKEMON_COUNT}`); const d = await r.json(); pokemonData = d.results.map((p, i) => ({ id: i + 1, name: p.name.charAt(0).toUpperCase() + p.name.slice(1), sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${i + 1}.png` })); isDexLoaded = true;} catch (e) { console.error("PokÃ©mon fetch failed:", e); }}
        async function loadUserDexData() { if (!currentUser) return; const snap = await getDoc(doc(db, `users/${currentUser.uid}/dex/shiny-dex`)); userDexData = snap.exists() ? new Set(snap.data().captured || []) : new Set(); }
        async function loadPendingVerifications() { if (!currentUser) return; userPendingData = new Set(); const q = query(collection(db, "verification-requests"), where("userId", "==", currentUser.uid), where("status", "==", "pending")); const snapshot = await getDocs(q); snapshot.forEach(d => userPendingData.add(d.data().pokemonId)); }
        
        function renderDexGrid() {
            if (discordUser) document.getElementById('dex-counter').textContent = `${userDexData.size} / ${POKEMON_COUNT}`;
            dexGridEl.innerHTML = pokemonData.map(p => { const isCap = userDexData.has(p.id), isPen = userPendingData.has(p.id); const status = isCap ? 'captured' : (isPen ? 'pending' : ''); return `<div class="dex-entry ${status}" data-id="${p.id}"><img src="${p.sprite}" class="sprite"><p>#${String(p.id).padStart(3,'0')}</p><p class="text-xs text-gray-400">${p.name}</p></div>`; }).join('');
            document.querySelectorAll('.dex-entry').forEach(e => e.addEventListener('click', (ev) => { if (!discordUser) { handleLogin(); return; } const id = parseInt(ev.currentTarget.dataset.id); if (userDexData.has(id) || userPendingData.has(id)) return; const p = pokemonData.find(pk => pk.id === id); if (p) openVerificationModal(p); }));
        }
        function openVerificationModal(p) { verifyPokemonIdInput.value = p.id; verifyPokemonNameEl.textContent = `Verify: ${p.name}`; verifyPokemonSpriteEl.src = p.sprite; verifyDiscordUserInput.value = discordUser.username; verificationForm.reset(); verificationModal.classList.remove('hidden'); }
        function closeVerificationModal() { verificationModal.classList.add('hidden'); }
        async function handleVerificationSubmit(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.textContent = '...';
            const pokemonId = parseInt(verifyPokemonIdInput.value);
            const requestData = {
                userId: currentUser.uid, discordUsername: discordUser.username, discordId: discordUser.id,
                pokemonId: pokemonId, pokemonName: pokemonData.find(p => p.id === pokemonId).name,
                inGameName: e.target['verify-ingame-name'].value, characterImage: e.target['verify-character-image'].value,
                dateCaptured: e.target['verify-date'].value, encounters: e.target['verify-encounters'].value || null,
                status: 'pending', submittedAt: serverTimestamp()
            };
            try {
                await addDoc(collection(db, "verification-requests"), requestData);
                userPendingData.add(pokemonId);
                renderDexGrid(); closeVerificationModal();
            } catch (error) { console.error("Submit error:", error); alert("Failed to submit.");
            } finally { btn.disabled = false; btn.textContent = 'Submit'; }
        }

        async function loadAndRenderShinyHall() {
            const q = query(collection(db, "verification-requests"), where("status", "==", "approved"));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { document.getElementById('shiny-hall-grid').innerHTML = `<p class="col-span-full text-center text-gray-400">Hall of Fame is empty.</p>`; return; }
            document.getElementById('shiny-hall-grid').innerHTML = snapshot.docs.map(d => { const e = d.data();
                return `<div class="hall-entry"><img src="${pokemonData[e.pokemonId-1].sprite}" class="pokemon-sprite"><img src="images/characters/${e.characterImage}" class="character-image" onerror="this.src='https://placehold.co/80x80/374151/9ca3af?text=N/A'"><h3 class="text-xl font-bold mt-2">${e.pokemonName}</h3><p class="text-sm font-semibold text-gray-300">${e.inGameName}</p><p class="text-xs text-gray-500">by ${e.discordUsername}</p><div class="bg-gray-700/50 rounded-md p-3 w-full mt-4 text-xs text-gray-300 space-y-1"><p><strong>Date:</strong> ${e.dateCaptured}</p>${e.encounters ? `<strong>Encounters:</strong> ${e.encounters}` : ''}</div></div>`;
            }).join('');
        }
        async function loadAndRenderVerificationQueue() {
            const q = query(collection(db, "verification-requests"), where("status", "==", "pending"));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { verificationQueueEl.innerHTML = `<p class="text-center text-gray-400">No pending verifications.</p>`; return; }
            verificationQueueEl.innerHTML = snapshot.docs.map(d => { const e = d.data();
                return `<div class="verification-card grid grid-cols-1 md:grid-cols-3 gap-4 items-center" id="req-${d.id}"><div class="flex items-center gap-4"><img src="${pokemonData[e.pokemonId-1].sprite}" class="w-16 h-16 bg-gray-700 rounded-md"><div class="text-sm"><p class="font-bold text-lg">${e.pokemonName}</p><p class="text-gray-400">${e.inGameName}</p><p class="text-gray-500">${e.discordUsername}</p></div></div><div class="text-sm text-gray-300"><p><strong>Date:</strong> ${e.dateCaptured}</p><p><strong>Encounters:</strong> ${e.encounters || 'N/A'}</p><p><strong>Character:</strong> ${e.characterImage}</p></div><div class="flex gap-2 justify-end"><button data-id="${d.id}" data-action="approve" class="action-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Approve</button><button data-id="${d.id}" data-action="deny" class="action-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Deny</button></div></div>`;
            }).join('');
            document.querySelectorAll('.action-btn').forEach(b => b.addEventListener('click', handleVerificationAction));
        }
        async function handleVerificationAction(e) {
            const { id, action } = e.target.dataset;
            e.target.disabled = true; e.target.textContent = '...';
            const reqRef = doc(db, "verification-requests", id);
            try {
                if (action === 'approve') {
                    const reqSnap = await getDoc(reqRef);
                    const reqData = reqSnap.data();
                    const userQuery = query(collection(db, 'users'), where('discordId', '==', reqData.discordId));
                    const userSnap = await getDocs(userQuery);
                    if (!userSnap.empty) {
                        const userDocRef = userSnap.docs[0].ref;
                        const dexRef = doc(userDocRef, 'dex/shiny-dex');
                        const dexSnap = await getDoc(dexRef);
                        if (dexSnap.exists()) await updateDoc(dexRef, { captured: arrayUnion(reqData.pokemonId) });
                        else await setDoc(dexRef, { captured: [reqData.pokemonId] });
                    }
                    await updateDoc(reqRef, { status: 'approved' });
                } else { await deleteDoc(reqRef); }
                document.getElementById(`req-${id}`).remove();
                if (verificationQueueEl.children.length === 0) verificationQueueEl.innerHTML = `<p class="text-center text-gray-400">No pending verifications.</p>`;
            } catch (error) { console.error(`Failed to ${action}:`, error); e.target.disabled = false; e.target.textContent = action; }
        }
        
        async function loadSiteMasterPanel() {
            loadAllRanks(); loadAllUsers();
            isMasterPanelLoaded = true;
            document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${e.target.dataset.tab}-tab`).classList.remove('hidden');
            }));
            const permsContainer = document.getElementById('permissions-container');
            permsContainer.innerHTML = ALL_PERMISSIONS.map(p => `<div><input type="checkbox" id="perm-${p}" name="permissions" value="${p}" class="mr-2"><label for="perm-${p}">${p.replace(/_/g, ' ')}</label></div>`).join('');
        }
        async function loadAllRanks() {
            const snapshot = await getDocs(collection(db, 'ranks'));
            allRanks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderRanksList();
        }
        function renderRanksList() {
            ranksListEl.innerHTML = allRanks.map(r => `<div class="bg-gray-700 p-3 rounded-md flex justify-between items-center"><div><p class="font-bold">${r.name}</p><p class="text-xs text-gray-400">${(r.permissions || []).join(', ')}</p></div><div class="space-x-2"><button class="edit-rank-btn text-blue-400 hover:text-blue-300" data-id="${r.id}">Edit</button><button class="delete-rank-btn text-red-400 hover:text-red-300" data-id="${r.id}">Delete</button></div></div>`).join('');
            ranksListEl.querySelectorAll('.edit-rank-btn').forEach(b => b.addEventListener('click', (e) => { const r = allRanks.find(rk => rk.id === e.target.dataset.id); if(r) { document.getElementById('rank-id').value = r.id; document.getElementById('rank-name').value = r.name; ALL_PERMISSIONS.forEach(p => document.getElementById(`perm-${p}`).checked = (r.permissions || []).includes(p)); } }));
            ranksListEl.querySelectorAll('.delete-rank-btn').forEach(b => b.addEventListener('click', async (e) => { if(confirm('Delete rank?')) { await deleteDoc(doc(db, 'ranks', e.target.dataset.id)); loadAllRanks(); } }));
        }
        rankForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('rank-id').value, name = document.getElementById('rank-name').value;
            const permissions = Array.from(document.querySelectorAll('[name=permissions]:checked')).map(el => el.value);
            const rankData = { name, permissions };
            if (id) await setDoc(doc(db, 'ranks', id), rankData); else await addDoc(collection(db, 'ranks'), rankData);
            rankForm.reset(); document.getElementById('rank-id').value = ''; loadAllRanks();
        });
        document.getElementById('clear-rank-form').addEventListener('click', () => { rankForm.reset(); document.getElementById('rank-id').value = ''; });
        
        async function loadAllUsers() {
            const snapshot = await getDocs(collection(db, 'users'));
            allUsers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderUserList();
        }
        function renderUserList(filter = '') {
            const filteredUsers = allUsers.filter(u => u.username.toLowerCase().includes(filter.toLowerCase()));
            userListEl.innerHTML = filteredUsers.map(u => {
                const currentRank = allRanks.find(r => r.id === u.rankId);
                return `<div class="bg-gray-700 p-3 rounded-md flex justify-between items-center"><span>${u.username}</span><div><span class="text-gray-400">${currentRank ? currentRank.name : 'No Rank'}</span><select class="assign-rank-select bg-gray-600 ml-2 rounded p-1" data-userid="${u.id}"><option value="">Assign Rank</option>${allRanks.map(r => `<option value="${r.id}" ${u.rankId === r.id ? 'selected' : ''}>${r.name}</option>`).join('')}</select></div></div>`
            }).join('');
            userListEl.querySelectorAll('.assign-rank-select').forEach(s => s.addEventListener('change', async (e) => {
                const userDocRef = doc(db, 'users', e.target.dataset.userid);
                await updateDoc(userDocRef, { rankId: e.target.value });
                loadAllUsers();
            }));
        }
        userSearchInput.addEventListener('input', (e) => renderUserList(e.target.value));

        function createFlyingCrows(n) { Array.from({ length: n }).forEach(() => {
            const c = document.createElement('img'); c.src = 'images/flyingcrows.gif'; c.className = 'flying-crow';
            c.style.top = `${Math.random()*80}vh`; c.style.animationDuration = `${10+Math.random()*10}s`; c.style.animationDelay = `${Math.random()*15}s`;
            document.getElementById('flying-crows-container').appendChild(c); });
        }

        function renderAuthButtons() {
            authButtonsContainer.innerHTML = discordUser ? `<div class="flex items-center justify-center"><img src="${discordUser.avatar ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png'}" class="w-10 h-10 rounded-full mr-4"><span>${discordUser.username}</span></div>` : `<button id="login-btn" class="discord-btn text-white font-bold py-3 px-6 rounded-lg inline-flex items-center text-lg"><svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.36981C18.276 2.88453 15.9317 2.02922 13.431 2.00003C10.9303 2.02922 8.58601 2.88453 6.54501 4.36981C4.38371 6.0123 2.82531 8.23419 2.08501 10.749C1.98418 11.1373 2.02894 11.543 2.21045 11.8955C2.39196 12.248 2.69777 12.528 3.06801 12.6932L5.12101 13.664C5.43851 13.8213 5.80183 13.8587 6.14901 13.7702C6.49619 13.6817 6.80496 13.4713 7.02801 13.1772C7.32168 12.7836 7.5532 12.3682 7.71701 11.936C7.50013 11.753 7.32174 11.5335 7.19201 11.2882C6.47432 10.1581 6.33851 8.82381 6.80401 7.64121C7.26951 6.45861 8.28801 5.58023 9.54401 5.24123C10.8 4.90222 12.114 5.14365 13.1259 5.88583C14.1378 6.62801 14.7423 7.79813 14.794 9.06421C14.795 9.44421 14.717 9.81821 14.565 10.1652C15.176 11.64 15.029 13.284 14.195 14.612C13.36 15.942 11.983 16.821 10.471 16.983C9.07929 17.1439 7.64134 16.592 6.54501 15.4812V15.4812C7.45266 16.2088 8.56342 16.6669 9.76101 16.8012C11.536 17.0212 13.313 16.4802 14.671 15.3042C15.2217 14.8113 15.6813 14.2312 16.033 13.5932C16.293 14.2492 16.69 14.8512 17.206 15.3612C18.151 16.2152 19.399 16.7002 20.702 16.7002C20.999 16.6992 21.285 16.6092 21.522 16.4422C21.93 16.1582 22.1 15.6512 21.936 15.1752C21.432 13.6232 20.455 12.2922 19.14 11.4312C18.8182 11.2036 18.4485 11.0493 18.056 10.9812C18.441 10.4852 18.732 9.91421 18.911 9.29421C19.131 8.52821 19.131 7.71221 18.911 6.94621C18.643 5.98621 18.016 5.16021 17.14 4.60021C16.264 4.04021 15.194 3.80021 14.13 3.94521C14.542 3.32821 15.042 2.79321 15.61 2.36121C16.179 1.92921 16.809 1.60521 17.472 1.40121L17.58 0.0712128C17.348 -0.0167872 17.102 -0.0577872 16.858 0.0242128C14.821 0.443213 12.971 1.47221 11.525 2.99821C10.795 3.75021 10.199 4.61521 9.77601 5.56021C10.451 5.45221 11.14 5.43321 11.823 5.50521C12.871 5.61521 13.841 6.06221 14.551 6.77221C15.261 7.48221 15.665 8.40621 15.665 9.38021C15.665 10.3542 15.261 11.2782 14.551 11.9882C13.841 12.6982 12.871 13.1452 11.823 13.2552C11.14 13.3272 10.451 13.3082 9.77601 13.2002C9.55701 14.0372 9.14101 14.8112 8.55901 15.4812L8.55901 15.4822C7.65136 16.2098 6.5406 16.6679 5.34301 16.8022C4.14542 16.9365 2.95379 16.7374 1.90501 16.2332C1.7235 15.8797 1.62267 15.484 1.61101 15.0822C2.17549 13.8076 3.12033 12.7834 4.31901 12.1642C3.59601 10.8802 3.32101 9.42321 3.54501 7.99421C3.76901 6.56521 4.47901 5.25321 5.56101 4.29521C7.45855 2.59972 9.94334 1.66421 12.5 1.69321H12.501C15.0577 1.66421 17.5424 2.59972 19.44 4.29521C20.522 5.25321 21.232 6.56521 21.456 7.99421C21.68 9.42321 21.405 10.8802 20.682 12.1632C21.8807 12.7834 22.8255 13.8076 23.389 15.0782C23.3773 15.484 23.2765 15.8797 23.096 16.2322C22.0462 16.7374 20.8546 16.9365 19.657 16.8022C18.4594 16.6679 17.3486 16.2098 16.441 15.4822C15.859 14.8112 15.443 14.0372 15.224 13.2002C14.549 13.3082 13.86 13.3272 13.177 13.2552C12.129 13.1452 11.159 12.6982 10.449 11.9882C9.73901 11.2782 9.33501 10.3542 9.33501 9.38021C9.33501 8.40621 9.73901 7.48221 10.449 6.77221C11.159 6.06221 12.129 5.61521 13.177 5.50521C13.86 5.43321 14.549 5.45221 15.224 5.56021C14.801 4.61521 14.205 3.75021 13.475 2.99821C12.029 1.47221 10.179 0.443213 8.14201 0.0242128C7.89801 -0.0577872 7.65201 -0.0167872 7.42101 0.0712128L7.52801 1.40121C8.19101 1.60521 8.82101 1.92921 9.39001 2.36121C9.95801 2.79321 10.458 3.32821 10.873 3.94521C9.80601 3.80021 8.73601 4.04021 7.86001 4.60021C6.98401 5.16021 6.35701 5.98621 6.08901 6.94621C5.86901 7.71221 5.86901 8.52821 6.08901 9.29421C6.26801 9.91421 6.55901 10.4852 6.94401 10.9812C6.55153 11.0493 6.18182 11.2036 5.86001 11.4312C4.54501 12.2922 3.56801 13.6232 3.06401 15.1752C2.90001 15.6512 3.07001 16.1582 3.47801 16.4422C3.71501 16.6092 4.00101 16.6992 4.29501 16.7002C5.60101 16.7002 6.84901 16.2152 7.79401 15.3612C8.31001 14.8512 8.70701 14.2492 8.96701 13.5932C9.31869 14.2312 9.77831 14.8113 10.329 15.3042C11.687 16.4802 13.464 17.0212 15.239 16.8012C16.4366 16.6669 17.5474 16.2088 18.455 15.4812C19.4587 16.592 20.9207 17.1439 22.312 16.983C23.824 16.821 25.201 15.942 26.035 14.614C26.87 13.284 27.023 11.64 26.411 10.1672C26.259 9.81821 26.181 9.44421 26.181 9.06521C26.2327 7.79813 26.8372 6.62801 27.8491 5.88583C28.861 5.14365 30.175 4.90222 31.431 5.24123C32.687 5.58023 33.7055 6.45861 34.171 7.64121C34.6365 8.82381 34.5007 10.1581 33.784 11.2872C33.6543 11.5335 33.4759 11.753 33.259 11.936C33.4228 12.3682 33.6543 12.7836 33.948 13.1772C34.171 13.4713 34.4798 13.6817 34.827 13.7702C35.1742 13.8587 35.5375 13.8213 35.855 13.664L37.908 12.6932C38.2782 12.528 38.584 12.248 38.7655 11.8955C38.9471 11.543 38.9918 11.1373 38.891 10.749C38.1507 8.23419 36.5923 6.0123 34.431 4.36981C32.39 2.88453 30.0457 2.02922 27.545 2.00003C25.0443 2.02922 22.699 2.88453 20.658 4.36981L20.317 4.36981Z"/></svg>Login with Discord</button>`;
            if (document.getElementById('login-btn')) document.getElementById('login-btn').addEventListener('click', handleLogin);
        }
        function renderClaimSiteState() {
            showView('landing');
            authButtonsContainer.innerHTML = `<button id="claim-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg inline-flex items-center text-lg"><i class="fa-solid fa-flag mr-3"></i>Claim This Site</button>`;
            document.getElementById('claim-btn').addEventListener('click', handleLogin);
        }
        
        function renderLoggedOutState() { showView('landing'); renderAuthButtons(); }
        
        // --- Event Listeners ---
        iconLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); showPage(link.dataset.page); }));
        backBtns.forEach(btn => btn.addEventListener('click', () => { showView('landing'); }));
        verificationForm.addEventListener('submit', handleVerificationSubmit);
        cancelVerificationBtn.addEventListener('click', closeVerificationModal);
        
        showView('loading'); createFlyingCrows(5); initializeAppLogic();
    </script>
</body>
</html>

