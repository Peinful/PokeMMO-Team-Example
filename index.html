<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crow Syndicate - PokeMMO Team</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-image: url('images/background-sky.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .discord-btn { background-color: #5865F2; transition: background-color 0.3s ease; }
        .discord-btn:hover { background-color: #4752C4; }
        .loader { border-top-color: #5865F2; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .circular-container { position: relative; width: 350px; height: 350px; display: flex; justify-content: center; align-items: center; border-radius: 50%; }
        .center-logo { width: 140px; height: 140px; background-color: rgba(31, 41, 55, 0.8); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 4px solid #4b5563; z-index: 10; }
        .center-logo img { width: 100px; height: 100px; }

        .icon-item {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transform: rotate(calc(360deg / 10 * var(--i))); /* For 10 icons */
            pointer-events: none;
        }
        .icon-item a {
            position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%) rotate(0deg) translateY(-175px);
            width: 60px; height: 60px; background: #2b3748; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #9ca3af; font-size: 1.5rem; border: 2px solid #4b5563;
            cursor: pointer; transition: all 0.3s ease; pointer-events: auto;
        }
        .icon-item a .fa-solid { transform: rotate(calc(-360deg / 10 * var(--i))); transition: transform 0.3s ease; }
        .icon-item a:hover { background-color: #5865F2; color: #fff; border-color: #5865F2; box-shadow: 0 0 15px #5865F2; }
        .icon-item a:hover .fa-solid { transform: rotate(calc(-360deg / 10 * var(--i))) scale(1.2); }
        
        #flying-crows-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; overflow: hidden; z-index: 1; }
        .flying-crow {
            position: absolute; width: 200px; height: 176px;
            animation: fly-across linear infinite backwards; opacity: 0;
        }
        @keyframes fly-across {
            0% { transform: translateX(100vw); opacity: 0; } 5% { opacity: 1; }
            95% { opacity: 1; } 100% { transform: translateX(-200px); opacity: 0; }
        }
        
        .fullscreen-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.95); backdrop-filter: blur(10px); overflow-y: auto; z-index: 50; }
        .content-grid { display: grid; gap: 1.5rem; }
        .dex-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        .shiny-hall-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
        .dex-entry { background-color: #374151; border-radius: 0.5rem; padding: 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .dex-entry:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); border-color: #5865F2; }
        .dex-entry.pending { border-color: #FBBF24; }
        .dex-entry.captured, .dex-entry.pending { cursor: not-allowed; }
        .dex-entry img.sprite { width: 96px; height: 96px; margin: 0 auto; transition: filter 0.3s ease; filter: brightness(0); }
        .dex-entry.captured img.sprite { filter: brightness(1); }
        .dex-entry.pending img.sprite { filter: brightness(1) grayscale(50%); }

        .hall-entry { background-color: #374151; border-radius: 0.75rem; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
        .hall-entry .pokemon-sprite { width: 128px; height: 128px; }
        .hall-entry .character-image { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #4b5563; margin-top: -40px; background-color: #374151; }
        .verification-card { background-color: #1F2937; border-radius: 0.5rem; padding: 1rem; border-left: 4px solid #FBBF24; }
        .tab-btn { background-color: #374151; }
        .tab-btn.active { background-color: #5865F2; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="flying-crows-container"></div>
    <div id="app" class="w-full max-w-5xl mx-auto" style="position: relative; z-index: 5;">
        <div id="loading" class="text-center">
             <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
             <p class="text-lg text-gray-400">Loading your PokeMMO Hub...</p>
        </div>
        <div id="landing-view" class="hidden flex-col items-center text-center">
             <div class="circular-container mb-12">
                <div class="center-logo"><img src="images/crow.png" alt="Crow Syndicate Logo"></div>
                <div class="icon-item" style="--i: 0;"><a data-page="shiny-dex" data-tooltip="Shiny Dex"><i class="fa-solid fa-wand-magic-sparkles"></i></a></div>
                <div class="icon-item" style="--i: 1;"><a data-page="about-us" data-tooltip="About Us"><i class="fa-solid fa-circle-info"></i></a></div>
                <div class="icon-item" style="--i: 2;"><a data-page="members" data-tooltip="Members"><i class="fa-solid fa-users"></i></a></div>
                <div class="icon-item" style="--i: 3;"><a data-page="recruitment" data-tooltip="Recruitment"><i class="fa-solid fa-user-plus"></i></a></div>
                <div class="icon-item" style="--i: 4;"><a data-page="shiny-hall" data-tooltip="Shiny Hall"><i class="fa-solid fa-star"></i></a></div>
                <div class="icon-item" style="--i: 5;"><a data-page="tournaments" data-tooltip="Tournaments"><i class="fa-solid fa-trophy"></i></a></div>
                <div class="icon-item" style="--i: 6;"><a data-page="bounties" data-tooltip="Bounties"><i class="fa-solid fa-crosshairs"></i></a></div>
                <div class="icon-item" style="--i: 7;"><a data-page="gallery" data-tooltip="Gallery"><i class="fa-solid fa-images"></i></a></div>
                <div id="verification-panel-icon" class="icon-item hidden" style="--i: 8;"><a data-page="verification-panel" data-tooltip="Verifications"><i class="fa-solid fa-shield-halved"></i></a></div>
                <div id="sitemaster-panel-icon" class="icon-item hidden" style="--i: 9;"><a data-page="sitemaster-panel" data-tooltip="Site Master"><i class="fa-solid fa-crown"></i></a></div>
             </div>
             <h1 class="text-6xl font-bold text-white drop-shadow-lg" style="text-shadow: 2px 2px 4px #000;">Crow Syndicate</h1>
             <p class="text-gray-200 mb-8 max-w-md bg-black bg-opacity-50 p-2 rounded-md">A PokeMMO team focused on competitive play, community, and strategy.</p>
             <div id="auth-buttons"></div>
        </div>
    </div>

    <!-- Fullscreen Pages -->
    <div id="shiny-dex-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button><h1>Shiny Dex</h1>
            <div id="dex-counter" class="w-24 text-right">0 / 0</div>
        </header><main id="dex-grid" class="content-grid dex-grid"></main>
    </div>
    <div id="shiny-hall-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button><h1>Shiny Hall of Fame</h1><div class="w-24"></div>
        </header><main id="shiny-hall-grid" class="content-grid shiny-hall-grid"></main>
    </div>
    <div id="verification-panel-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button><h1>Verification Panel</h1><div class="w-24"></div>
        </header>
        <main><h2 class="text-2xl font-semibold mb-4">Pending Shiny Verifications</h2><div id="verification-queue" class="space-y-4"></div></main>
    </div>
    <div id="sitemaster-panel-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button><h1>Site Master Panel</h1><div class="w-24"></div>
        </header>
        <main>
            <div class="flex border-b border-gray-700 mb-6"><div class="tabs">
                <button class="tab-btn py-2 px-4 rounded-t-lg active" data-tab="ranks">Manage Ranks</button>
                <button class="tab-btn py-2 px-4 rounded-t-lg" data-tab="users">Manage Users</button>
            </div></div>
            <div id="ranks-tab" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4">Ranks</h2>
                <div id="ranks-list" class="space-y-4"></div>
                <form id="rank-form" class="mt-8 bg-gray-800 p-4 rounded-lg"><h3 class="text-xl font-bold mb-4">Create/Edit Rank</h3>
                    <input type="hidden" id="rank-id"><input type="text" id="rank-name" placeholder="Rank Name" class="w-full bg-gray-700 p-2 rounded-md mb-4" required>
                    <div id="permissions-container" class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4"></div>
                    <button type="submit" class="discord-btn py-2 px-4 rounded-lg">Save Rank</button>
                    <button type="button" id="clear-rank-form" class="bg-gray-600 py-2 px-4 rounded-lg ml-2">Clear</button>
                </form>
            </div>
            <div id="users-tab" class="tab-content hidden"><h2 class="text-2xl font-semibold mb-4">Assign Ranks</h2>
                <div class="flex gap-4"><input type="text" id="user-search" placeholder="Search by Discord Username" class="flex-grow bg-gray-700 p-2 rounded-md"></div>
                <div id="user-list" class="mt-4 space-y-2"></div>
            </div>
        </main>
    </div>
    
    <div id="verification-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60]"><!-- Modal Content --></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, addDoc, serverTimestamp, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "##FIREBASE_API_KEY##", authDomain: "##FIREBASE_AUTH_DOMAIN##", projectId: "##FIREBASE_PROJECT_ID##", storageBucket: "##FIREBASE_STORAGE_BUCKET##", messagingSenderId: "##FIREBASE_MESSAGING_SENDER_ID##", appId: "##FIREBASE_APP_ID##" };
        const DISCORD_CLIENT_ID = "##DISCORD_CLIENT_ID##"; 
        const POKEMON_COUNT = 649;
        const ALL_PERMISSIONS = ['can_verify_shinies', 'can_manage_recruitment', 'can_edit_pages', 'can_manage_bounties'];

        let currentUser = null, discordUser = null, isSiteMaster = false, userPermissions = new Set();
        let pokemonData = [], allRanks = [], allUsers = [];
        let isDexLoaded = false, isHallLoaded = false, isStaffPanelLoaded = false, isMasterPanelLoaded = false;
        
        const appViews = { loading: document.getElementById('loading'), landing: document.getElementById('landing-view'), shinyDex: document.getElementById('shiny-dex-view'), shinyHall: document.getElementById('shiny-hall-view'), verificationPanel: document.getElementById('verification-panel-view'), siteMasterPanel: document.getElementById('sitemaster-panel-view') };
        const verificationPanelIcon = document.getElementById('verification-panel-icon'), sitemasterPanelIcon = document.getElementById('sitemaster-panel-icon');
        const authButtonsContainer = document.getElementById('auth-buttons'), backBtns = document.querySelectorAll('.back-btn');
        const dexGridEl = document.getElementById('dex-grid'), verificationQueueEl = document.getElementById('verification-queue');
        const rankForm = document.getElementById('rank-form'), ranksListEl = document.getElementById('ranks-list');
        const userSearchInput = document.getElementById('user-search'), userListEl = document.getElementById('user-list');

        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Firebase init failed.", e); }
        
        function showView(viewName) {
            document.body.style.overflow = ['shinyDex', 'shinyHall', 'verificationPanel', 'siteMasterPanel'].includes(viewName) ? 'auto' : 'hidden';
            Object.values(appViews).forEach(v => v.classList.add('hidden'));
            if (appViews[viewName]) {
                appViews[viewName].classList.remove('hidden');
                if (viewName === 'landing') appViews[viewName].classList.add('flex');
            }
        }

        async function initializeAppLogic() {
            if (!auth) return;
            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user) {
                    const discordToken = getDiscordToken();
                    if (discordToken) {
                        showView('landing');
                        try {
                            discordUser = await fetchDiscordUser(discordToken);
                            await Promise.all([ saveUserToFirestore(user.uid, discordUser), loadUserRankAndPermissions(discordUser.id) ]);
                            renderAuthButtons();
                            loadUserDexData(); loadPendingVerifications();
                        } catch (error) { console.error("Login flow error:", error); clearSession(true); }
                    } else { renderLoggedOutState(); }
                } else { signInAnonymously(auth).catch(console.error); }
            });
        }
        
        function handleLogin() { window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&response_type=token&scope=identify`; }
        function getDiscordToken() {
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            const token = fragment.get('access_token');
            if (token) { localStorage.setItem('discord_token', token); window.history.replaceState({}, '', window.location.pathname); return token; }
            return localStorage.getItem('discord_token');
        }
        async function fetchDiscordUser(token) {
            const r = await fetch('https://discord.com/api/users/@me', { headers: { authorization: `Bearer ${token}` } });
            if (!r.ok) throw new Error(`Discord API Error: ${r.status}`);
            return await r.json();
        }
        async function saveUserToFirestore(uid, dUser) { await setDoc(doc(db, 'users', uid), { discordId: dUser.id, username: dUser.username, avatar: dUser.avatar }, { merge: true }); }
        async function loadUserRankAndPermissions(discordId) {
            const masterSnap = await getDoc(doc(db, 'config', 'sitemaster'));
            if (masterSnap.exists() && masterSnap.data().members.includes(discordId)) {
                isSiteMaster = true;
                sitemasterPanelIcon.classList.remove('hidden');
            }
            const userSnap = await getDocs(query(collection(db, 'users'), where('discordId', '==', discordId)));
            if (!userSnap.empty) {
                const userData = userSnap.docs[0].data();
                if (userData.rankId) {
                    const rankSnap = await getDoc(doc(db, 'ranks', userData.rankId));
                    if (rankSnap.exists()) {
                        userPermissions = new Set(rankSnap.data().permissions || []);
                        if (userPermissions.has('can_verify_shinies')) verificationPanelIcon.classList.remove('hidden');
                    }
                }
            }
        }
        function clearSession(isError = false) {
            localStorage.removeItem('discord_token');
            discordUser = null; isSiteMaster = false; userPermissions.clear();
            if (!isError) window.location.href = window.location.pathname;
            else renderLoggedOutState();
        }

        async function showPage(page) {
            const handlers = {
                'shiny-dex': async () => { if (!isDexLoaded) await fetchPokemonData(); renderDexGrid(); showView('shinyDex'); },
                'shiny-hall': async () => { if (!isHallLoaded) await fetchPokemonData(); await loadAndRenderShinyHall(); showView('shinyHall'); },
                'verification-panel': async () => { if (userPermissions.has('can_verify_shinies')) { if(!isStaffPanelLoaded) await fetchPokemonData(); await loadAndRenderVerificationQueue(); showView('verificationPanel'); } },
                'sitemaster-panel': async () => { if (isSiteMaster) { if(!isMasterPanelLoaded) await loadSiteMasterPanel(); showView('siteMasterPanel'); } },
                'members': () => { if (discordUser) showView('dashboard'); else handleLogin(); }
            };
            if(handlers[page]) handlers[page]();
        }

        async function fetchPokemonData() { if (pokemonData.length > 0) return; try { const r = await fetch(`https://pokeapi.co/api/v2/pokemon?limit=${POKEMON_COUNT}`); const d = await r.json(); pokemonData = d.results.map((p, i) => ({ id: i + 1, name: p.name.charAt(0).toUpperCase() + p.name.slice(1), sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${i + 1}.png` })); isDexLoaded = true;} catch (e) { console.error("PokÃ©mon fetch failed:", e); }}
        async function loadUserDexData() { if (!currentUser) return; const snap = await getDoc(doc(db, `users/${currentUser.uid}/dex/shiny-dex`)); userDexData = snap.exists() ? new Set(snap.data().captured || []) : new Set(); }
        async function loadPendingVerifications() { if (!currentUser) return; userPendingData = new Set(); const q = query(collection(db, "verification-requests"), where("userId", "==", currentUser.uid), where("status", "==", "pending")); const snapshot = await getDocs(q); snapshot.forEach(d => userPendingData.add(d.data().pokemonId)); }
        
        function renderDexGrid() {
            if (discordUser) document.getElementById('dex-counter').textContent = `${userDexData.size} / ${POKEMON_COUNT}`;
            dexGridEl.innerHTML = pokemonData.map(p => { const isCap = userDexData.has(p.id), isPen = userPendingData.has(p.id); const status = isCap ? 'captured' : (isPen ? 'pending' : ''); return `<div class="dex-entry ${status}" data-id="${p.id}"><img src="${p.sprite}" class="sprite"><p>#${String(p.id).padStart(3,'0')}</p><p class="text-xs text-gray-400">${p.name}</p></div>`; }).join('');
            document.querySelectorAll('.dex-entry').forEach(e => e.addEventListener('click', (ev) => { if (!discordUser) { handleLogin(); return; } const id = parseInt(ev.currentTarget.dataset.id); if (userDexData.has(id) || userPendingData.has(id)) return; const p = pokemonData.find(pk => pk.id === id); if (p) openVerificationModal(p); }));
        }
        function openVerificationModal(p) { verifyPokemonIdInput.value = p.id; verifyPokemonNameEl.textContent = `Verify: ${p.name}`; verifyPokemonSpriteEl.src = p.sprite; verifyDiscordUserInput.value = discordUser.username; verificationForm.reset(); verificationModal.classList.remove('hidden'); }
        function closeVerificationModal() { verificationModal.classList.add('hidden'); }
        async function handleVerificationSubmit(e) { e.preventDefault(); /* ... same as before ... */ }

        async function loadAndRenderShinyHall() { /* ... same as before ... */ }
        async function loadAndRenderVerificationQueue() { /* ... same as before ... */ }
        async function handleVerificationAction(e) { /* ... same as before ... */ }
        
        // --- SITE MASTER PANEL LOGIC ---
        async function loadSiteMasterPanel() {
            loadAllRanks(); loadAllUsers();
            isMasterPanelLoaded = true;
            document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${e.target.dataset.tab}-tab`).classList.remove('hidden');
            }));
            const permsContainer = document.getElementById('permissions-container');
            permsContainer.innerHTML = ALL_PERMISSIONS.map(p => `<div><input type="checkbox" id="perm-${p}" name="permissions" value="${p}" class="mr-2"><label for="perm-${p}">${p.replace(/_/g, ' ')}</label></div>`).join('');
        }
        async function loadAllRanks() {
            const snapshot = await getDocs(collection(db, 'ranks'));
            allRanks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderRanksList();
        }
        function renderRanksList() {
            ranksListEl.innerHTML = allRanks.map(r => `<div class="bg-gray-700 p-3 rounded-md flex justify-between items-center"><div><p class="font-bold">${r.name}</p><p class="text-xs text-gray-400">${(r.permissions || []).join(', ')}</p></div><div><button class="edit-rank-btn" data-id="${r.id}">Edit</button><button class="delete-rank-btn" data-id="${r.id}">Delete</button></div></div>`).join('');
            ranksListEl.querySelectorAll('.edit-rank-btn').forEach(b => b.addEventListener('click', (e) => { const r = allRanks.find(rk => rk.id === e.target.dataset.id); if(r) { document.getElementById('rank-id').value = r.id; document.getElementById('rank-name').value = r.name; ALL_PERMISSIONS.forEach(p => document.getElementById(`perm-${p}`).checked = (r.permissions || []).includes(p)); } }));
            ranksListEl.querySelectorAll('.delete-rank-btn').forEach(b => b.addEventListener('click', async (e) => { if(confirm('Delete rank?')) { await deleteDoc(doc(db, 'ranks', e.target.dataset.id)); loadAllRanks(); } }));
        }
        rankForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('rank-id').value;
            const name = document.getElementById('rank-name').value;
            const permissions = Array.from(document.querySelectorAll('[name=permissions]:checked')).map(el => el.value);
            const rankData = { name, permissions };
            if (id) await setDoc(doc(db, 'ranks', id), rankData);
            else await addDoc(collection(db, 'ranks'), rankData);
            rankForm.reset(); document.getElementById('rank-id').value = ''; loadAllRanks();
        });
        document.getElementById('clear-rank-form').addEventListener('click', () => { rankForm.reset(); document.getElementById('rank-id').value = ''; });
        
        async function loadAllUsers() {
            const snapshot = await getDocs(collection(db, 'users'));
            allUsers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderUserList();
        }
        function renderUserList(filter = '') {
            const filteredUsers = allUsers.filter(u => u.username.toLowerCase().includes(filter.toLowerCase()));
            userListEl.innerHTML = filteredUsers.map(u => {
                const currentRank = allRanks.find(r => r.id === u.rankId);
                return `<div class="bg-gray-700 p-3 rounded-md flex justify-between items-center"><span>${u.username}</span><div><span>${currentRank ? currentRank.name : 'No Rank'}</span><select class="assign-rank-select bg-gray-600 ml-2" data-userid="${u.id}"><option value="">Assign Rank</option>${allRanks.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}</select></div></div>`
            }).join('');
            userListEl.querySelectorAll('.assign-rank-select').forEach(s => s.addEventListener('change', async (e) => {
                const userId = e.target.dataset.userid;
                const rankId = e.target.value;
                await updateDoc(doc(db, 'users', userId), { rankId });
                loadAllUsers();
            }));
        }
        userSearchInput.addEventListener('input', (e) => renderUserList(e.target.value));

        // --- Init ---
        function renderAuthButtons() { /* ... */ }
        function renderLoggedOutState() { showView('landing'); renderAuthButtons(); }
        iconLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); showPage(link.dataset.page); }));
        backBtns.forEach(btn => btn.addEventListener('click', () => { showView('landing'); }));
        
        showView('loading'); createFlyingCrows(5); initializeAppLogic();
    </script>
</body>
</html>

