<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crow Syndicate - PokeMMO Team</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-image: url('images/background-sky.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .discord-btn {
            background-color: #5865F2;
            transition: background-color 0.3s ease;
        }
        .discord-btn:hover {
            background-color: #4752C4;
        }
        .loader {
            border-top-color: #5865F2;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .circular-container {
            position: relative;
            width: 350px;
            height: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
        }

        .center-logo {
            width: 140px;
            height: 140px;
            background-color: rgba(31, 41, 55, 0.8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid #4b5563;
            z-index: 10;
        }
        
        .center-logo img {
            width: 100px;
            height: 100px;
        }

        .icon-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(calc(360deg / 6 * var(--i)));
        }

        .icon-item a {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) rotate(0deg) translateY(-175px); /* Changed rotation to 0 */
            width: 60px;
            height: 60px;
            background: #2b3748;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #9ca3af;
            font-size: 1.5rem;
            border: 2px solid #4b5563;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .icon-item a .fa-solid {
             transform: rotate(calc(-360deg / 6 * var(--i))); /* Keep icon upright */
             transition: transform 0.3s ease;
        }

        .icon-item a:hover {
            background-color: #5865F2;
            color: #fff;
            border-color: #5865F2;
            box-shadow: 0 0 15px #5865F2;
        }
        
        .icon-item a:hover .fa-solid {
            transform: rotate(calc(-360deg / 6 * var(--i))) scale(1.2);
        }
        
        #flying-crows-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }

        .flying-crow {
            position: absolute;
            width: 200px;
            height: 176px;
            left: 0; 
            transform: translateX(100vw);
            animation-name: fly-across;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            animation-fill-mode: backwards; /* This is the fix! */
        }

        @keyframes fly-across {
            from {
                transform: translateX(100vw);
            }
            to {
                transform: translateX(-200px); 
            }
        }

    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="flying-crows-container"></div>

    <div id="app" class="w-full max-w-5xl mx-auto" style="position: relative; z-index: 5;">
        
        <!-- Loading State -->
        <div id="loading" class="text-center">
             <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
             <p class="text-lg text-gray-400">Loading your PokeMMO Hub...</p>
        </div>
        
        <!-- Landing Page View -->
        <div id="landing-view" class="hidden flex-col items-center text-center">
             <div class="circular-container mb-12">
                <div class="center-logo">
                    <img src="images/crow.png" alt="Crow Syndicate Logo">
                </div>
                <!-- Icons will be positioned around the logo -->
                <div class="icon-item" style="--i: 0;"><a data-tooltip="Members"><i class="fa-solid fa-users"></i></a></div>
                <div class="icon-item" style="--i: 1;"><a data-tooltip="Events"><i class="fa-solid fa-calendar-days"></i></a></div>
                <div class="icon-item" style="--i: 2;"><a data-tooltip="Achievements"><i class="fa-solid fa-trophy"></i></a></div>
                <div class="icon-item" style="--i: 3;"><a data-tooltip="Rules & Lore"><i class="fa-solid fa-scroll"></i></a></div>
                <div class="icon-item" style="--i: 4;"><a data-tooltip="PvP Records"><i class="fa-solid fa-khanda"></i></a></div>
                <div class="icon-item" style="--i: 5;"><a data-tooltip="Strategies"><i class="fa-solid fa-shield-halved"></i></a></div>
             </div>
             <h1 class="text-6xl font-bold mb-4 text-white drop-shadow-lg" style="text-shadow: 2px 2px 4px #000000;">Crow Syndicate</h1>
             <p class="text-gray-200 mb-8 max-w-md bg-black bg-opacity-50 p-2 rounded-md">A PokeMMO team focused on competitive play, community, and strategy. Log in to join the ranks.</p>
             
             <div id="auth-buttons">
                <!-- Login/Logout buttons will be injected here -->
             </div>
        </div>

        <!-- Dashboard View (Previously Main View) -->
        <div id="dashboard-view" class="hidden">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-700">
                <div id="user-profile" class="flex items-center mb-4 sm:mb-0">
                    <!-- User info will be injected here -->
                </div>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Logout
                </button>
            </header>

            <main class="bg-gray-800 rounded-xl p-6 shadow-lg">
                <h2 id="team-name" class="text-3xl font-bold mb-6 text-center"></h2>
                <div id="team-members" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Team members will be injected here -->
                </div>
                <div id="join-team-container" class="text-center mt-8 hidden">
                     <p class="text-gray-400 mb-4">You are not yet a member of the syndicate.</p>
                     <button id="join-team-btn" class="discord-btn text-white font-bold py-3 px-6 rounded-lg text-lg">
                        Join Crow Syndicate
                     </button>
                </div>
            </main>
        </div>

    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- ⚙️ CONFIGURATION - These will be replaced by GitHub Actions ---
        const firebaseConfig = {
            apiKey: "##FIREBASE_API_KEY##",
            authDomain: "##FIREBASE_AUTH_DOMAIN##",
            projectId: "##FIREBASE_PROJECT_ID##",
            storageBucket: "##FIREBASE_STORAGE_BUCKET##",
            messagingSenderId: "##FIREBASE_MESSAGING_SENDER_ID##",
            appId: "##FIREBASE_APP_ID##"
        };
        const DISCORD_CLIENT_ID = "##DISCORD_CLIENT_ID##"; 
        const TEAM_ID = "crow-syndicate"; // Hardcoded team ID for now
        // --- END CONFIGURATION ---

        // --- STATE ---
        let currentUser = null;
        let discordUser = null;

        // --- UI ELEMENTS ---
        const loadingEl = document.getElementById('loading');
        const landingViewEl = document.getElementById('landing-view');
        const dashboardViewEl = document.getElementById('dashboard-view');
        const authButtonsContainer = document.getElementById('auth-buttons');
        const userProfileEl = document.getElementById('user-profile');
        const teamNameEl = document.getElementById('team-name');
        const teamMembersEl = document.getElementById('team-members');
        const joinTeamContainer = document.getElementById('join-team-container');
        const joinTeamBtn = document.getElementById('join-team-btn');
        const logoutBtn = document.getElementById('logout-btn');


        // --- FIREBASE INITIALIZATION ---
        let app, auth, db;
        try {
            if (firebaseConfig.apiKey.startsWith("##")) throw new Error("Firebase keys not replaced.");
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("CRITICAL: Firebase initialization failed.", e);
            loadingEl.innerHTML = `<p class="text-red-400 text-lg">Error: Could not connect to services. Check console (F12).</p>`;
        }
        
        // --- VISUAL EFFECTS ---
        function createFlyingCrows(numberOfCrows) {
            const container = document.getElementById('flying-crows-container');
            if (!container) return;

            for (let i = 0; i < numberOfCrows; i++) {
                const crow = document.createElement('img');
                crow.src = 'images/flyingcrows.gif';
                crow.className = 'flying-crow';
                
                // Randomize vertical position and animation properties for a natural look
                crow.style.top = `${Math.random() * 80}vh`; // 0 to 80% of viewport height
                crow.style.animationDuration = `${10 + Math.random() * 10}s`; // 10 to 20 seconds
                crow.style.animationDelay = `${Math.random() * 15}s`; // 0 to 15 seconds delay

                container.appendChild(crow);
            }
        }


        // --- CORE LOGIC ---
        function initializeAppLogic() {
            if (!auth) return;
            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user) {
                    const discordToken = getDiscordToken();
                    if (discordToken) {
                        try {
                            discordUser = await fetchDiscordUser(discordToken);
                            await saveUserToFirestore(user.uid, discordUser);
                            renderLoggedInState(discordUser);
                            loadTeamData();
                        } catch (error) {
                            console.error("Error with Discord user:", error);
                            clearSession(true);
                        }
                    } else {
                        renderLoggedOutState();
                    }
                } else {
                    signInAnonymously(auth).catch(console.error);
                }
            });
        }
        
        function handleLogin() {
            if (DISCORD_CLIENT_ID.startsWith("##")) {
                alert("Discord Client ID not configured.");
                return;
            }
            const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${redirectUri}&response_type=token&scope=identify`;
            window.location.href = authUrl;
        }

        function getDiscordToken() {
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            const token = fragment.get('access_token');
            if (token) {
                localStorage.setItem('discord_token', token);
                window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
                return token;
            }
            return localStorage.getItem('discord_token');
        }

        async function fetchDiscordUser(token) {
            const response = await fetch('https://discord.com/api/users/@me', {
                headers: { authorization: `Bearer ${token}` },
            });
            if (!response.ok) {
                if (response.status === 401) throw new Error('Invalid Discord token.');
                throw new Error(`Discord API error: ${response.statusText}`);
            }
            return await response.json();
        }

        async function saveUserToFirestore(firebaseUid, dUser) {
            const userRef = doc(db, 'users', firebaseUid);
            const userData = {
                discordId: dUser.id,
                username: dUser.username,
                avatar: dUser.avatar,
                lastLogin: new Date()
            };
            await setDoc(userRef, userData, { merge: true });
        }

        async function loadTeamData() {
            const teamRef = doc(db, 'teams', TEAM_ID);
            const teamSnap = await getDoc(teamRef);

            if (!teamSnap.exists()) {
                console.error("Team document does not exist!");
                teamNameEl.textContent = "Team Not Found";
                teamMembersEl.innerHTML = `<p class="text-center text-red-400 col-span-full">The team data could not be loaded. Please contact an administrator.</p>`;
                return;
            }
            
            const teamData = teamSnap.data();
            renderTeamInfo(teamData);

            const isMember = teamData.members.some(member => member.discordId === discordUser.id);
            if (isMember) {
                joinTeamContainer.classList.add('hidden');
            } else {
                joinTeamContainer.classList.remove('hidden');
            }
        }
        
        async function handleJoinTeam() {
            if (!discordUser) return;
            
            joinTeamBtn.disabled = true;
            joinTeamBtn.textContent = "Joining...";

            const teamRef = doc(db, 'teams', TEAM_ID);
            const newMember = {
                discordId: discordUser.id,
                username: discordUser.username,
                avatar: discordUser.avatar
            };

            try {
                await updateDoc(teamRef, {
                    members: arrayUnion(newMember)
                });
                // Reload data to show the user in the list
                loadTeamData();
            } catch (error) {
                console.error("Failed to join team:", error);
                alert("There was an error trying to join the team.");
                joinTeamBtn.disabled = false;
                joinTeamBtn.textContent = "Join Crow Syndicate";
            }
        }

        function clearSession(isError = false) {
            localStorage.removeItem('discord_token');
            if (!isError) {
                window.location.href = window.location.pathname + window.location.search;
            } else {
                 renderLoggedOutState();
            }
        }
        
        // --- UI RENDERING ---
        function renderLoggedOutState() {
            loadingEl.classList.add('hidden');
            dashboardViewEl.classList.add('hidden');
            landingViewEl.classList.remove('hidden');
            landingViewEl.classList.add('flex');

            authButtonsContainer.innerHTML = `
                <button id="login-btn" class="discord-btn text-white font-bold py-3 px-6 rounded-lg inline-flex items-center text-lg">
                    Login with Discord
                </button>`;
            document.getElementById('login-btn').addEventListener('click', handleLogin);
        }

        function renderLoggedInState(dUser) {
            loadingEl.classList.add('hidden');
            landingViewEl.classList.add('hidden');
            dashboardViewEl.classList.remove('hidden');

            const avatarUrl = dUser.avatar 
                ? `https://cdn.discordapp.com/avatars/${dUser.id}/${dUser.avatar}.png`
                : 'https://cdn.discordapp.com/embed/avatars/0.png';

            userProfileEl.innerHTML = `
                <img src="${avatarUrl}" alt="${dUser.username}'s avatar" class="w-12 h-12 rounded-full mr-4 border-2 border-gray-600">
                <div>
                    <p class="font-semibold text-lg">${dUser.username}</p>
                </div>`;
        }
        
        function renderTeamInfo(teamData) {
            teamNameEl.textContent = teamData.name;
            
            if (teamData.members && teamData.members.length > 0) {
                 teamMembersEl.innerHTML = teamData.members.map(member => {
                    const avatarUrl = member.avatar 
                        ? `https://cdn.discordapp.com/avatars/${member.discordId}/${member.avatar}.png`
                        : 'https://cdn.discordapp.com/embed/avatars/0.png';
                    return `
                        <div class="bg-gray-700 p-3 rounded-lg flex items-center shadow-md">
                            <img src="${avatarUrl}" class="w-10 h-10 rounded-full mr-3">
                            <span class="font-medium">${member.username}</span>
                        </div>
                    `;
                 }).join('');
            } else {
                teamMembersEl.innerHTML = `<p class="text-center text-gray-400 col-span-full">This team has no members yet.</p>`;
            }
        }

        // --- EVENT LISTENERS ---
        logoutBtn.addEventListener('click', () => clearSession(false));
        joinTeamBtn.addEventListener('click', handleJoinTeam);

        // --- APP START ---
        createFlyingCrows(5); // Add 5 flying crows to the scene
        initializeAppLogic();
    </script>
</body>
</html>

