<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crow Syndicate - PokeMMO Team</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-image: url('images/background-sky.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .discord-btn { background-color: #5865F2; transition: background-color 0.3s ease; }
        .discord-btn:hover { background-color: #4752C4; }
		.discord-username {
			background-image: linear-gradient(to right, #A1B2FF, #C2A7FF);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			text-fill-color: transparent;
			font-weight: 600; /* semi-bold */
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
		}
        .loader { border-top-color: #5865F2; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .circular-container { position: relative; width: 350px; height: 350px; display: flex; justify-content: center; align-items: center; border-radius: 50%; }
        .center-logo { width: 140px; height: 140px; background-color: rgba(31, 41, 55, 0.8); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 4px solid #4b5563; z-index: 10; }
        .center-logo img { width: 100px; height: 100px; }

		.icon-item {
			position: absolute; top: 0; left: 0; width: 100%; height: 100%;
			/* Change 10 to 9 here */
			transform: rotate(calc(360deg / 7 * var(--i))); 
			pointer-events: none;
		}
        .icon-item a {
            position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%) rotate(0deg) translateY(-175px);
            width: 60px; height: 60px; background: #2b3748; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #9ca3af; font-size: 1.5rem; border: 2px solid #4b5563;
            cursor: pointer; transition: all 0.3s ease; pointer-events: auto;
        }
        .icon-item a .fa-solid { transform: rotate(calc(-360deg / 7 * var(--i))); transition: transform 0.3s ease; }
        .icon-item a:hover { background-color: #5865F2; color: #fff; border-color: #5865F2; box-shadow: 0 0 15px #5865F2; }
        .icon-item a:hover .fa-solid { transform: rotate(calc(-360deg / 7 * var(--i))) scale(1.2); }
        
        #flying-crows-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; overflow: hidden; z-index: 1; }
        .flying-crow {
            position: absolute; width: 200px; height: 176px;
            animation: fly-across linear infinite backwards; opacity: 0;
        }
        @keyframes fly-across {
            0% { transform: translateX(100vw); opacity: 0; } 5% { opacity: 1; }
            95% { opacity: 1; } 100% { transform: translateX(-200px); opacity: 0; }
        }
        
        .fullscreen-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.95); backdrop-filter: blur(10px); overflow-y: auto; z-index: 50; }
        .content-grid { display: grid; gap: 1.5rem; }
        .dex-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        .shiny-hall-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
        .dex-entry { background-color: #374151; border-radius: 0.5rem; padding: 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .dex-entry:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); border-color: #5865F2; }
        .dex-entry.pending { border-color: #FBBF24; }
        .dex-entry.captured, .dex-entry.pending { cursor: not-allowed; }
        .dex-entry img.sprite { width: 96px; height: 96px; margin: 0 auto; transition: filter 0.3s ease; filter: brightness(0); }
        .dex-entry.captured img.sprite { filter: brightness(1); }
        .dex-entry.pending img.sprite { filter: brightness(1) grayscale(50%); }

        .hall-entry { background-color: #374151; border-radius: 0.75rem; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
        .hall-entry .pokemon-sprite { width: 128px; height: 128px; }
        .hall-entry .character-image { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #4b5563; margin-top: -40px; background-color: #374151; }
        .verification-card { background-color: #1F2937; border-radius: 0.5rem; padding: 1rem; border-left: 4px solid #FBBF24; }
        .tab-btn { background-color: #374151; }
        .tab-btn.active { background-color: #5865F2; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="flying-crows-container"></div>
    <div id="app" class="w-full max-w-5xl mx-auto" style="position: relative; z-index: 5;">
        <div id="loading" class="text-center">
             <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
             <p class="text-lg text-gray-400">Loading your PokeMMO Hub...</p>
        </div>
        <div id="landing-view" class="hidden flex-col items-center text-center">
             <div class="circular-container mb-12">
                <div class="center-logo"><img src="images/crow.png" alt="Crow Syndicate Logo"></div>
                <div class="icon-item" style="--i: 0;"><a data-page="shiny-dex" data-tooltip="Shiny Dex"><i class="fa-solid fa-wand-magic-sparkles"></i></a></div>
                <div class="icon-item" style="--i: 1;"><a data-page="about-us" data-tooltip="About Us"><i class="fa-solid fa-circle-info"></i></a></div>
                <div class="icon-item" style="--i: 2;"><a data-page="members" data-tooltip="Members"><i class="fa-solid fa-users"></i></a></div>
                <div class="icon-item" style="--i: 3;"><a data-page="recruitment" data-tooltip="Recruitment"><i class="fa-solid fa-user-plus"></i></a></div>
                <div class="icon-item" style="--i: 4;"><a data-page="shiny-hall" data-tooltip="Shiny Hall"><i class="fa-solid fa-star"></i></a></div>
                <div class="icon-item" style="--i: 5;"><a data-page="tournaments" data-tooltip="Tournaments"><i class="fa-solid fa-trophy"></i></a></div>
                <div class="icon-item" style="--i: 6;"><a data-page="bounties" data-tooltip="Bounties"><i class="fa-solid fa-crosshairs"></i></a></div>
                <div class="icon-item" style="--i: 7;"><a data-page="gallery" data-tooltip="Gallery"><i class="fa-solid fa-images"></i></a></div>
             </div>
             <h1 class="text-6xl font-bold text-white drop-shadow-lg" style="text-shadow: 2px 2px 4px #000;">Crow Syndicate</h1>
             <p class="text-gray-200 mb-8 max-w-md bg-black bg-opacity-50 p-2 rounded-md">A PokeMMO team focused on competitive play, community, and strategy.</p>
             <div id="auth-buttons"></div>
        </div>
    </div>
    
    <div id="dashboard-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors mb-4 sm:mb-0"><i class="fa-solid fa-arrow-left mr-2"></i> Back to Home</button>
            <div id="user-profile" class="flex items-center"></div>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Logout</button>
        </header>
        <main class="bg-gray-800 rounded-xl p-6 shadow-lg">
            <h2 id="team-name" class="text-3xl font-bold mb-6 text-center"></h2>
            <div id="team-members" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="join-team-container" class="text-center mt-8 hidden">
                 <p class="text-gray-400 mb-4">You are not yet a member of the syndicate.</p>
                 <button id="join-team-btn" class="discord-btn text-white font-bold py-3 px-6 rounded-lg text-lg">Join Crow Syndicate</button>
            </div>
        </main>
    </div>
    
    <div id="page-view" class="hidden fullscreen-page p-4 md:p-8">
         <header class="flex justify-start items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back to Home</button>
         </header>
         <main class="bg-gray-800 rounded-xl p-8 shadow-lg text-center">
            <h2 id="page-title" class="text-4xl font-bold mb-6"></h2>
            <div id="page-content" class="text-gray-300"><p>Content for this section is coming soon!</p></div>
         </main>
    </div>

    <!-- Fullscreen Pages -->
    <div id="shiny-dex-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
            <h1 class="text-3xl font-bold text-center">Shiny Dex</h1>
            <div id="dex-counter" class="w-24 text-right text-lg text-gray-400 font-semibold">0 / 0</div>
        </header><main id="dex-grid" class="content-grid dex-grid"></main>
    </div>
    <div id="shiny-hall-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
            <h1 class="text-3xl font-bold text-center">Shiny Hall of Fame</h1><div class="w-24"></div>
        </header><main id="shiny-hall-grid" class="content-grid shiny-hall-grid"></main>
    </div>
    <div id="verification-panel-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
            <h1 class="text-3xl font-bold text-center">Verification Panel</h1><div class="w-24"></div>
        </header>
        <main><h2 class="text-2xl font-semibold mb-4">Pending Shiny Verifications</h2><div id="verification-queue" class="space-y-4"></div></main>
    </div>
    <div id="staff-panel-view" class="hidden fullscreen-page p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
            <h1 class="text-3xl font-bold text-center">Staff Panel</h1><div class="w-24"></div>
        </header>
		<main>
			<div class="flex border-b border-gray-700 mb-6">
				<div class="tabs">
					<button id="verifications-tab-btn" class="tab-btn py-2 px-4 rounded-t-lg hidden" data-tab="verifications">Verifications</button>

					<button id="ranks-tab-btn" class="tab-btn py-2 px-4 rounded-t-lg hidden" data-tab="ranks">Manage Ranks</button>
					<button id="users-tab-btn" class="tab-btn py-2 px-4 rounded-t-lg hidden" data-tab="users">Manage Users</button>
				</div>
			</div>

			<div id="verifications-tab" class="tab-content hidden">
				<h2 class="text-2xl font-semibold mb-4">Pending Shiny Verifications</h2>
				<div id="verification-queue" class="space-y-4"></div>
			</div>

			<div id="ranks-tab" class="tab-content hidden">...</div>
			<div id="users-tab" class="tab-content hidden">...</div>
		</main>
    </div>
    
    <div id="verification-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60]">
        <div class="bg-gray-800 rounded-lg p-8 w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="verify-pokemon-name" class="text-2xl font-bold">Verify Shiny Capture</h2>
                 <img id="verify-pokemon-sprite" src="" class="w-16 h-16">
            </div>
            <p class="text-gray-400 mb-6">Submit the details of your capture for verification by staff.</p>
            <form id="verification-form">
                <input type="hidden" id="verify-pokemon-id">
                <div class="mb-4">
                    <label for="verify-discord-user" class="block text-sm font-medium text-gray-300 mb-1">Discord Username</label>
                    <input type="text" id="verify-discord-user" name="verify-discord-user" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" readonly>
                </div>
                <div class="mb-4">
                    <label for="verify-ingame-name" class="block text-sm font-medium text-gray-300 mb-1">In-game Name</label>
                    <input type="text" id="verify-ingame-name" name="verify-ingame-name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" required>
                </div>
                 <div class="mb-4">
                    <label for="verify-character-image" class="block text-sm font-medium text-gray-300 mb-1">Character Image Filename</label>
                    <input type="text" id="verify-character-image" name="verify-character-image" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" placeholder="e.g., your-name.png" required>
                    <p class="text-xs text-gray-500 mt-1">Upload image to 'images/characters' in the repo and enter the filename.</p>
                </div>
                <div class="mb-4">
                    <label for="verify-date" class="block text-sm font-medium text-gray-300 mb-1">Date Captured</label>
                    <input type="date" id="verify-date" name="verify-date" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" required>
                </div>
                <div class="mb-4">
                    <label for="verify-encounters" class="block text-sm font-medium text-gray-300 mb-1">Encounters (Optional)</label>
                    <input type="number" id="verify-encounters" name="verify-encounters" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" min="0">
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-verification-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="discord-btn text-white font-bold py-2 px-4 rounded-lg">Submit</button>
                </div>
            </form>
        </div>
    </div>

	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
		import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, addDoc, serverTimestamp, deleteDoc, writeBatch, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
		import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
		
		// --- CONFIGURATION ---
		const firebaseConfig = { apiKey: "##FIREBASE_API_KEY##", authDomain: "##FIREBASE_AUTH_DOMAIN##", projectId: "##FIREBASE_PROJECT_ID##", storageBucket: "##FIREBASE_STORAGE_BUCKET##", messagingSenderId: "##FIREBASE_MESSAGING_SENDER_ID##", appId: "##FIREBASE_APP_ID##" };
		const DISCORD_CLIENT_ID = "##DISCORD_CLIENT_ID##"; 
		const TEAM_ID = "crow-syndicate"; // UPDATED: Abstracted Team ID for easy templating.
		const POKEMON_COUNT = 649;
		const ALL_PERMISSIONS = ['can_verify_shinies', 'can_manage_recruitment', 'can_edit_pages', 'can_manage_bounties'];

		// --- STATE ---
		let currentUser = null, discordUser = null, isSiteMaster = false, userPermissions = new Set();
		let pokemonData = [], allRanks = [], allUsers = [];
		let userDexData = new Set(), userPendingData = new Set();
		let isDexLoaded = false, isHallLoaded = false, isStaffPanelLoaded = false, isMasterPanelLoaded = false;
		
		// --- UI ELEMENTS ---
		const appViews = { 
			loading: document.getElementById('loading'), 
			landing: document.getElementById('landing-view'), 
			dashboard: document.getElementById('dashboard-view'),
			page: document.getElementById('page-view'),
			shinyDex: document.getElementById('shiny-dex-view'), 
			shinyHall: document.getElementById('shiny-hall-view'), 
			verificationPanel: document.getElementById('verification-panel-view'), 
			staffPanel: document.getElementById('staff-panel-view') 
		};
		const authButtonsContainer = document.getElementById('auth-buttons'), backBtns = document.querySelectorAll('.back-btn');
		const iconLinks = document.querySelectorAll('.icon-item a');
		const dexGridEl = document.getElementById('dex-grid'), verificationQueueEl = document.getElementById('verification-queue');
		const rankForm = document.getElementById('rank-form'), ranksListEl = document.getElementById('ranks-list');
		const userSearchInput = document.getElementById('user-search'), userListEl = document.getElementById('user-list');
		const verificationModal = document.getElementById('verification-modal'), verificationForm = document.getElementById('verification-form');
		const cancelVerificationBtn = document.getElementById('cancel-verification-btn');
		const verifyPokemonIdInput = document.getElementById('verify-pokemon-id'), verifyPokemonNameEl = document.getElementById('verify-pokemon-name');
		const verifyPokemonSpriteEl = document.getElementById('verify-pokemon-sprite'), verifyDiscordUserInput = document.getElementById('verify-discord-user');
		const pageTitleEl = document.getElementById('page-title'), pageContentEl = document.getElementById('page-content');
		const logoutBtn = document.getElementById('logout-btn'), joinTeamBtn = document.getElementById('join-team-btn');
		const userProfileEl = document.getElementById('user-profile'), teamNameEl = document.getElementById('team-name'), teamMembersEl = document.getElementById('team-members');
		const joinTeamContainer = document.getElementById('join-team-container');


		let app, auth, db;
		try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Firebase init failed.", e); }
		
		function showView(viewName) {
			document.body.style.overflow = ['shinyDex', 'shinyHall', 'verificationPanel', 'siteMasterPanel'].includes(viewName) ? 'auto' : 'hidden';
			Object.values(appViews).forEach(v => v.classList.add('hidden'));
			if (appViews[viewName]) {
				appViews[viewName].classList.remove('hidden');
				if (viewName === 'landing') appViews[viewName].classList.add('flex');
			}
		}

		async function initializeAppLogic() {
			if (!auth) return;
			const siteMasterRef = doc(db, 'config', 'sitemaster');
			const siteMasterSnap = await getDoc(siteMasterRef);

			if (!siteMasterSnap.exists()) {
				renderClaimSiteState();
				onAuthStateChanged(auth, async (user) => {
					if (user) {
						const discordToken = getDiscordToken();
						if (discordToken) {
							showView('loading');
							try {
								const claimingUser = await fetchDiscordUser(discordToken);
								await setDoc(siteMasterRef, { members: [claimingUser.id] });
								window.location.reload();
							} catch (error) { console.error("Failed to claim site:", error); clearSession(true); }
						}
					} else { signInAnonymously(auth).catch(console.error); }
				});
			} else {
				onAuthStateChanged(auth, async (user) => {
					currentUser = user;
					if (user) {
						const discordToken = getDiscordToken();
						if (discordToken) {
							showView('landing');
							try {
								discordUser = await fetchDiscordUser(discordToken);
								await Promise.all([saveUserToFirestore(user.uid, discordUser), loadUserRankAndPermissions()]);
								renderAuthButtons();
								loadTeamData();
								loadUserDexData();
								loadPendingVerifications();
							} catch (error) { console.error("Login flow error:", error); clearSession(true); }
						} else { renderLoggedOutState(); }
					} else { signInAnonymously(auth).catch(console.error); }
				});
			}
		}
		
		function handleLogin() { window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&response_type=token&scope=identify`; }
		function getDiscordToken() {
			const fragment = new URLSearchParams(window.location.hash.substring(1));
			const token = fragment.get('access_token');
			if (token) { localStorage.setItem('discord_token', token); window.history.replaceState({}, '', window.location.pathname); return token; }
			return localStorage.getItem('discord_token');
		}
		async function fetchDiscordUser(token) {
			const r = await fetch('https://discord.com/api/users/@me', { headers: { authorization: `Bearer ${token}` } });
			if (!r.ok) throw new Error(`Discord API Error: ${r.status}`);
			return await r.json();
		}
		async function saveUserToFirestore(uid, dUser) { await setDoc(doc(db, 'users', uid), { discordId: dUser.id, username: dUser.username, avatar: dUser.avatar }, { merge: true }); }
		
		async function loadUserRankAndPermissions() {
			if (!discordUser) return;
			const masterSnap = await getDoc(doc(db, 'config', 'sitemaster'));

			// Check for Site Master status first
			if (masterSnap.exists() && masterSnap.data().members.includes(discordUser.id)) {
				isSiteMaster = true;
				// UPDATED: If user is a Site Master, give them all permissions automatically.
				userPermissions = new Set(ALL_PERMISSIONS);
			}

			// Then, check for rank permissions (for non-Site Masters)
			const userSnap = await getDoc(doc(db, 'users', currentUser.uid));
			if (!isSiteMaster && userSnap.exists() && userSnap.data().rankId) {
				const rankSnap = await getDoc(doc(db, 'ranks', userSnap.data().rankId));
				if (rankSnap.exists()) {
					userPermissions = new Set(rankSnap.data().permissions || []);
				}
			}
			
			updateUIVisibility(); // Update the UI with the correct permissions
		}

		// UPDATED: Corrected function to no longer reference the deleted icon.
		function updateUIVisibility() {
			// Map permissions to the element ID of their corresponding icon.
			const permissionToIconId = {
				'can_verify_shinies': 'verification-panel-icon',
				// e.g., 'can_manage_bounties': 'bounties-icon'
			};

			// Hide all permission-based icons initially, checking if they exist first.
			Object.values(permissionToIconId).forEach(id => {
				const iconElement = document.getElementById(id);
				if (iconElement) {
					iconElement.classList.add('hidden');
				}
			});

			// Show icons based on the user's permissions.
			userPermissions.forEach(perm => {
				const iconId = permissionToIconId[perm];
				const iconElement = document.getElementById(iconId);
				if (iconElement) {
					iconElement.classList.remove('hidden');
				}
			});

			// The logic for the Site Master button is now handled entirely in renderAuthButtons,
			// so no code is needed here for it.
		}
		
		async function loadTeamData() {
			const teamRef = doc(db, 'teams', TEAM_ID); // UPDATED: Use variable
			const teamSnap = await getDoc(teamRef);
			if (!teamSnap.exists()) return console.error("Team doc not found!");
			renderTeamInfo(teamSnap.data());
		}

		function clearSession(isError = false) {
			localStorage.removeItem('discord_token');
			discordUser = null; isSiteMaster = false; userPermissions.clear();
			if (!isError) window.location.href = window.location.pathname;
			else renderLoggedOutState();
		}

		async function showPage(page) {
			// UPDATED: Page handlers now include permission checks before running.
			const handlers = {
				'shiny-dex': async () => { if (!isDexLoaded) await fetchPokemonData(); renderDexGrid(); showView('shinyDex'); },
				'shiny-hall': async () => { if (!isHallLoaded) await fetchPokemonData(); await loadAndRenderShinyHall(); showView('shinyHall'); },
				// NEW UNIFIED STAFF PANEL HANDLER
				'staff-panel': async () => {
					const canAccess = isSiteMaster || ALL_PERMISSIONS.some(p => userPermissions.has(p));
					if (!canAccess) return;
					await renderStaffPanel();
					showView('staffPanel');
				},
				'members': () => {
					if (discordUser) { 
						loadTeamData(); 
						showView('dashboard'); 
					} else { 
						handleLogin(); 
					}
				}
				// You can add other permission-gated pages here
				// 'bounties': async () => {
				//     if (!userPermissions.has('can_manage_bounties') && !isSiteMaster) return;
				//     // ... load bounties page
				// }
			};
			if(handlers[page]) {
				handlers[page]();
			} else {
				const link = document.querySelector(`a[data-page="${page}"]`);
				if(link) {
					pageTitleEl.textContent = link.dataset.tooltip;
					pageContentEl.innerHTML = `<p>Content for the ${link.dataset.tooltip} section is coming soon!</p>`;
					showView('page');
				}
			}
		}
		
		// ADD THIS NEW FUNCTION to render the staff panel dynamically
		async function renderStaffPanel() {
			// --- Tab Visibility Logic ---
			const tabs = {
				verifications: document.getElementById('verifications-tab-btn'),
				ranks: document.getElementById('ranks-tab-btn'),
				users: document.getElementById('users-tab-btn'),
			};
			const tabContents = {
				verifications: document.getElementById('verifications-tab'),
				ranks: document.getElementById('ranks-tab'),
				users: document.getElementById('users-tab'),
			}

			// Hide everything first
			Object.values(tabs).forEach(t => t.classList.add('hidden'));
			Object.values(tabContents).forEach(tc => tc.classList.add('hidden'));

			let firstVisibleTab = null;

			if (userPermissions.has('can_verify_shinies') || isSiteMaster) {
				tabs.verifications.classList.remove('hidden');
				if (!firstVisibleTab) firstVisibleTab = 'verifications';
				await fetchPokemonData();
				await loadAndRenderVerificationQueue();
			}
			if (isSiteMaster) {
				tabs.ranks.classList.remove('hidden');
				tabs.users.classList.remove('hidden');
				if (!firstVisibleTab) firstVisibleTab = 'ranks';
				if (!isMasterPanelLoaded) {
					const permsContainer = document.getElementById('permissions-container');
					permsContainer.innerHTML = ALL_PERMISSIONS.map(p => `<div><input type="checkbox" id="perm-${p}" name="permissions" value="${p}" class="mr-2"><label for="perm-${p}">${p.replace(/_/g, ' ')}</label></div>`).join('');
					loadAllRanks();
					loadAllUsers();
					isMasterPanelLoaded = true;
				}
			}

			// --- Activate the first visible tab ---
			if (firstVisibleTab) {
				Object.values(tabs).forEach(t => t.classList.remove('active'));
				tabs[firstVisibleTab].classList.add('active');
				tabContents[firstVisibleTab].classList.remove('hidden');
			}

			// --- Tab click listeners (run only once) ---
			if (!document.getElementById('staff-panel-view').dataset.listenersAttached) {
				Object.values(tabs).forEach(button => {
					button.addEventListener('click', (e) => {
						const tabId = e.target.dataset.tab;
						Object.values(tabs).forEach(t => t.classList.remove('active'));
						e.target.classList.add('active');
						Object.values(tabContents).forEach(tc => tc.classList.add('hidden'));
						tabContents[tabId].classList.remove('hidden');
					});
				});
				document.getElementById('staff-panel-view').dataset.listenersAttached = 'true';
			}
		}

		async function fetchPokemonData() { if (pokemonData.length > 0) return; try { const r = await fetch(`https://pokeapi.co/api/v2/pokemon?limit=${POKEMON_COUNT}`); const d = await r.json(); pokemonData = d.results.map((p, i) => ({ id: i + 1, name: p.name.charAt(0).toUpperCase() + p.name.slice(1), sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${i + 1}.png` })); isDexLoaded = true;} catch (e) { console.error("PokÃ©mon fetch failed:", e); }}
		async function loadUserDexData() { if (!currentUser) return; const snap = await getDoc(doc(db, `users/${currentUser.uid}/dex/shiny-dex`)); userDexData = snap.exists() ? new Set(snap.data().captured || []) : new Set(); }
		async function loadPendingVerifications() { if (!currentUser) return; userPendingData = new Set(); const q = query(collection(db, "verification-requests"), where("userId", "==", currentUser.uid), where("status", "==", "pending")); const snapshot = await getDocs(q); snapshot.forEach(d => userPendingData.add(d.data().pokemonId)); }
		
		function renderDexGrid() {
			if (discordUser) document.getElementById('dex-counter').textContent = `${userDexData.size} / ${POKEMON_COUNT}`;
			dexGridEl.innerHTML = pokemonData.map(p => { const isCap = userDexData.has(p.id), isPen = userPendingData.has(p.id); const status = isCap ? 'captured' : (isPen ? 'pending' : ''); return `<div class="dex-entry ${status}" data-id="${p.id}"><img src="${p.sprite}" class="sprite"><p>#${String(p.id).padStart(3,'0')}</p><p class="text-xs text-gray-400">${p.name}</p></div>`; }).join('');
			document.querySelectorAll('.dex-entry').forEach(e => e.addEventListener('click', (ev) => { if (!discordUser) { handleLogin(); return; } const id = parseInt(ev.currentTarget.dataset.id); if (userDexData.has(id) || userPendingData.has(id)) return; const p = pokemonData.find(pk => pk.id === id); if (p) openVerificationModal(p); }));
		}
		function openVerificationModal(p) { verifyPokemonIdInput.value = p.id; verifyPokemonNameEl.textContent = `Verify: ${p.name}`; verifyPokemonSpriteEl.src = p.sprite; verifyDiscordUserInput.value = discordUser.username; verificationForm.reset(); verificationModal.classList.remove('hidden'); }
		function closeVerificationModal() { verificationModal.classList.add('hidden'); }
		async function handleVerificationSubmit(e) {
			e.preventDefault();
			const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.textContent = '...';
			const pokemonId = parseInt(verifyPokemonIdInput.value);
			const requestData = {
				userId: currentUser.uid, discordUsername: discordUser.username, discordId: discordUser.id,
				pokemonId: pokemonId, pokemonName: pokemonData.find(p => p.id === pokemonId).name,
				inGameName: e.target['verify-ingame-name'].value, characterImage: e.target['verify-character-image'].value,
				dateCaptured: e.target['verify-date'].value, encounters: e.target['verify-encounters'].value || null,
				status: 'pending', submittedAt: serverTimestamp()
			};
			try {
				await addDoc(collection(db, "verification-requests"), requestData);
				userPendingData.add(pokemonId);
				renderDexGrid(); closeVerificationModal();
			} catch (error) { console.error("Submit error:", error); alert("Failed to submit.");
			} finally { btn.disabled = false; btn.textContent = 'Submit'; }
		}

		async function loadAndRenderShinyHall() {
			const q = query(collection(db, "verification-requests"), where("status", "==", "approved"));
			const snapshot = await getDocs(q);
			if (snapshot.empty) { document.getElementById('shiny-hall-grid').innerHTML = `<p class="col-span-full text-center text-gray-400">Hall of Fame is empty.</p>`; return; }
			document.getElementById('shiny-hall-grid').innerHTML = snapshot.docs.map(d => { const e = d.data();
				return `<div class="hall-entry"><img src="${pokemonData.find(p => p.id === e.pokemonId)?.sprite}" class="pokemon-sprite"><img src="images/characters/${e.characterImage}" class="character-image" onerror="this.src='https://placehold.co/80x80/374151/9ca3af?text=N/A'"><h3 class="text-xl font-bold mt-2">${e.pokemonName}</h3><p class="text-sm font-semibold text-gray-300">${e.inGameName}</p><p class="text-xs text-gray-500">by ${e.discordUsername}</p><div class="bg-gray-700/50 rounded-md p-3 w-full mt-4 text-xs text-gray-300 space-y-1"><p><strong>Date:</strong> ${e.dateCaptured}</p>${e.encounters ? `<strong>Encounters:</strong> ${e.encounters}` : ''}</div></div>`;
			}).join('');
		}
		async function loadAndRenderVerificationQueue() {
			const q = query(collection(db, "verification-requests"), where("status", "==", "pending"));
			const snapshot = await getDocs(q);
			if (snapshot.empty) { verificationQueueEl.innerHTML = `<p class="text-center text-gray-400">No pending verifications.</p>`; return; }
			verificationQueueEl.innerHTML = snapshot.docs.map(d => { const e = d.data();
				return `<div class="verification-card grid grid-cols-1 md:grid-cols-3 gap-4 items-center" id="req-${d.id}"><div class="flex items-center gap-4"><img src="${pokemonData.find(p => p.id === e.pokemonId)?.sprite}" class="w-16 h-16 bg-gray-700 rounded-md"><div class="text-sm"><p class="font-bold text-lg">${e.pokemonName}</p><p class="text-gray-400">${e.inGameName}</p><p class="text-gray-500">${e.discordUsername}</p></div></div><div class="text-sm text-gray-300"><p><strong>Date:</strong> ${e.dateCaptured}</p><p><strong>Encounters:</strong> ${e.encounters || 'N/A'}</p><p><strong>Character:</strong> ${e.characterImage}</p></div><div class="flex gap-2 justify-end"><button data-id="${d.id}" data-action="approve" class="action-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Approve</button><button data-id="${d.id}" data-action="deny" class="action-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Deny</button></div></div>`;
			}).join('');
			document.querySelectorAll('.action-btn').forEach(b => b.addEventListener('click', handleVerificationAction));
		}
		async function handleVerificationAction(e) {
			const { id, action } = e.target.dataset;
			e.target.disabled = true; e.target.textContent = '...';
			const reqRef = doc(db, "verification-requests", id);
			try {
				if (action === 'approve') {
					const reqSnap = await getDoc(reqRef);
					const reqData = reqSnap.data();
					const userQuery = query(collection(db, 'users'), where('discordId', '==', reqData.discordId));
					const userSnap = await getDocs(userQuery);
					if (!userSnap.empty) {
						const userDocRef = userSnap.docs[0].ref;
						const dexRef = doc(userDocRef, 'dex/shiny-dex');
						await setDoc(dexRef, { captured: arrayUnion(reqData.pokemonId) }, { merge: true });
					}
					await updateDoc(reqRef, { status: 'approved' });
				} else { await deleteDoc(reqRef); }
				document.getElementById(`req-${id}`).remove();
				if (verificationQueueEl.children.length === 0) verificationQueueEl.innerHTML = `<p class="text-center text-gray-400">No pending verifications.</p>`;
			} catch (error) { console.error(`Failed to ${action}:`, error); e.target.disabled = false; e.target.textContent = action; }
		}
		
		async function loadSiteMasterPanel() {
			loadAllRanks(); loadAllUsers();
			isMasterPanelLoaded = true;
			document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', (e) => {
				document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
				e.target.classList.add('active');
				document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
				document.getElementById(`${e.target.dataset.tab}-tab`).classList.remove('hidden');
			}));
			const permsContainer = document.getElementById('permissions-container');
			permsContainer.innerHTML = ALL_PERMISSIONS.map(p => `<div><input type="checkbox" id="perm-${p}" name="permissions" value="${p}" class="mr-2"><label for="perm-${p}">${p.replace(/_/g, ' ')}</label></div>`).join('');
		}
		async function loadAllRanks() {
			const snapshot = await getDocs(collection(db, 'ranks'));
			allRanks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
			renderRanksList();
		}
		function renderRanksList() {
			ranksListEl.innerHTML = allRanks.map(r => `<div class="bg-gray-700 p-3 rounded-md flex justify-between items-center"><div><p class="font-bold">${r.name}</p><p class="text-xs text-gray-400">${(r.permissions || []).join(', ')}</p></div><div class="space-x-2"><button class="edit-rank-btn text-blue-400 hover:text-blue-300" data-id="${r.id}">Edit</button><button class="delete-rank-btn text-red-400 hover:text-red-300" data-id="${r.id}">Delete</button></div></div>`).join('');
			ranksListEl.querySelectorAll('.edit-rank-btn').forEach(b => b.addEventListener('click', (e) => { const r = allRanks.find(rk => rk.id === e.target.dataset.id); if(r) { document.getElementById('rank-id').value = r.id; document.getElementById('rank-name').value = r.name; ALL_PERMISSIONS.forEach(p => document.getElementById(`perm-${p}`).checked = (r.permissions || []).includes(p)); } }));
			ranksListEl.querySelectorAll('.delete-rank-btn').forEach(b => b.addEventListener('click', async (e) => { if(confirm('Delete rank?')) { await deleteDoc(doc(db, 'ranks', e.target.dataset.id)); loadAllRanks(); } }));
		}
		rankForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			const id = document.getElementById('rank-id').value, name = document.getElementById('rank-name').value;
			const permissions = Array.from(document.querySelectorAll('[name=permissions]:checked')).map(el => el.value);
			const rankData = { name, permissions };
			if (id) await setDoc(doc(db, 'ranks', id), rankData); else await addDoc(collection(db, 'ranks'), rankData);
			rankForm.reset(); document.getElementById('rank-id').value = ''; loadAllRanks();
		});
		document.getElementById('clear-rank-form').addEventListener('click', () => { rankForm.reset(); document.getElementById('rank-id').value = ''; });
		
		async function loadAllUsers() {
			const snapshot = await getDocs(collection(db, 'users'));
			allUsers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
			renderUserList();
		}
		function renderUserList(filter = '') {
			const filteredUsers = allUsers.filter(u => u.username.toLowerCase().includes(filter.toLowerCase()));
			userListEl.innerHTML = filteredUsers.map(u => {
				const currentRank = allRanks.find(r => r.id === u.rankId);
				return `<div class="bg-gray-700 p-3 rounded-md flex justify-between items-center"><span>${u.username}</span><div><span class="text-gray-400">${currentRank ? currentRank.name : 'No Rank'}</span><select id="rank-select-${u.id}" name="user-rank-assignment" class="assign-rank-select bg-gray-600 ml-2 rounded p-1" data-userid="${u.id}"><option value="">Assign Rank</option>${allRanks.map(r => `<option value="${r.id}" ${u.rankId === r.id ? 'selected' : ''}>${r.name}</option>`).join('')}</select></div></div>`
			}).join('');
			userListEl.querySelectorAll('.assign-rank-select').forEach(s => s.addEventListener('change', async (e) => {
				const userDocRef = doc(db, 'users', e.target.dataset.userid);
				await updateDoc(userDocRef, { rankId: e.target.value });
				loadAllUsers();
			}));
		}
		userSearchInput.addEventListener('input', (e) => renderUserList(e.target.value));

		function createFlyingCrows(n) { Array.from({ length: n }).forEach(() => {
			const c = document.createElement('img'); c.src = 'images/flyingcrows.gif'; c.className = 'flying-crow';
			c.style.top = `${Math.random()*80}vh`; c.style.animationDuration = `${10+Math.random()*10}s`; c.style.animationDelay = `${Math.random()*15}s`;
			document.getElementById('flying-crows-container').appendChild(c); });
		}
		
		// --- Dashboard/Team Functions ---
		function renderDashboardHeader() {
			if (!discordUser) return;
			const avatarUrl = discordUser.avatar ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png';
			userProfileEl.innerHTML = `<img src="${avatarUrl}" alt="${discordUser.username}'s avatar" class="w-12 h-12 rounded-full mr-4 border-2 border-gray-600"><div><p class="font-semibold text-lg">${discordUser.username}</p></div>`;
		}
		function renderTeamInfo(teamData) {
			teamNameEl.textContent = teamData.name;
			if (teamData.members && teamData.members.length > 0) {
				 teamMembersEl.innerHTML = teamData.members.map(member => {
					const avatarUrl = member.avatar ? `https://cdn.discordapp.com/avatars/${member.discordId}/${member.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png';
					return `<div class="bg-gray-700 p-3 rounded-lg flex items-center shadow-md"><img src="${avatarUrl}" class="w-10 h-10 rounded-full mr-3"><span>${member.username}</span></div>`;
				 }).join('');
			} else {
				teamMembersEl.innerHTML = `<p class="text-center text-gray-400 col-span-full">This team has no members yet.</p>`;
			}
			 if (discordUser) {
				const isMember = teamData.members.some(member => member.discordId === discordUser.id);
				joinTeamContainer.classList.toggle('hidden', isMember);
			}
		}
		 async function handleJoinTeam() {
			if (!discordUser) return;
			joinTeamBtn.disabled = true;
			joinTeamBtn.textContent = "Joining...";
			const teamRef = doc(db, 'teams', TEAM_ID); // UPDATED: Use variable
			const newMember = { discordId: discordUser.id, username: discordUser.username, avatar: discordUser.avatar };
			try {
				await updateDoc(teamRef, { members: arrayUnion(newMember) });
				loadTeamData();
			} catch (error) {
				console.error("Failed to join team:", error);
				alert("There was an error trying to join the team.");
			} finally {
				joinTeamBtn.disabled = false;
				joinTeamBtn.textContent = "Join Crow Syndicate";
			}
		}

		function renderAuthButtons() {
			if (discordUser) {
				const avatarUrl = discordUser.avatar ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png';

				// Check if the user has ANY staff permissions or is a Site Master
				const canAccessStaffPanel = isSiteMaster || ALL_PERMISSIONS.some(p => userPermissions.has(p));

				const staffButton = canAccessStaffPanel
					? `<button id="staff-panel-btn" class="ml-2 p-2 discord-btn text-white rounded-lg transition-all hover:shadow-lg" title="Staff Panel"><i class="fa-solid fa-user-shield"></i></button>`
					: '';

				const logoutButton = `<button id="user-logout-btn" class="ml-4 p-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all hover:shadow-lg" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></button>`;

				authButtonsContainer.innerHTML = `
					<div class="flex items-center justify-center">
						<img src="${avatarUrl}" class="w-10 h-10 rounded-full mr-4">
						<span class="text-lg discord-username">${discordUser.username}</span>
						${logoutButton}
						${staffButton}
					</div>`;

				document.getElementById('user-logout-btn').addEventListener('click', () => clearSession(false));

				if (canAccessStaffPanel) {
					document.getElementById('staff-panel-btn').addEventListener('click', () => showPage('staff-panel'));
				}
			} else {
				authButtonsContainer.innerHTML = `<button id="login-btn" class="discord-btn text-white font-bold py-3 px-6 rounded-lg inline-flex items-center text-lg"><svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="..."/></svg>Login with Discord</button>`;
				document.getElementById('login-btn').addEventListener('click', handleLogin);
			}
		}

		function renderClaimSiteState() {
			showView('landing');
			authButtonsContainer.innerHTML = `<button id="claim-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg inline-flex items-center text-lg"><i class="fa-solid fa-flag mr-3"></i>Claim This Site</button>`;
			document.getElementById('claim-btn').addEventListener('click', handleLogin);
		}
		
		function renderLoggedOutState() { showView('landing'); renderAuthButtons(); }
		
		// --- Event Listeners ---
		iconLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); showPage(link.dataset.page); }));
		backBtns.forEach(btn => btn.addEventListener('click', () => { showView('landing'); }));
		verificationForm.addEventListener('submit', handleVerificationSubmit);
		cancelVerificationBtn.addEventListener('click', closeVerificationModal);
		logoutBtn.addEventListener('click', () => clearSession(false));
		joinTeamBtn.addEventListener('click', handleJoinTeam);

		showView('loading'); createFlyingCrows(5); initializeAppLogic();
	</script>
</body>
</html>

