<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokeMMO Team Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .discord-btn {
            background-color: #5865F2;
            transition: background-color 0.3s ease;
        }
        .discord-btn:hover {
            background-color: #4752C4;
        }
        .loader {
            border-top-color: #5865F2;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-4xl mx-auto p-4 md:p-8">
        
        <!-- Loading State -->
        <div id="loading" class="text-center">
             <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
             <p class="text-lg text-gray-400">Loading your PokeMMO Hub...</p>
        </div>

        <!-- Login View -->
        <div id="login-view" class="hidden text-center bg-gray-800 rounded-xl p-8 shadow-2xl">
            <h1 class="text-4xl font-bold mb-2">Welcome to the PokeMMO Team Hub</h1>
            <p class="text-gray-400 mb-8">Log in with your Discord account to manage and view your teams.</p>
            <button id="login-btn" class="discord-btn text-white font-bold py-3 px-6 rounded-lg inline-flex items-center text-lg">
                <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.317 4.36981C18.276 2.88453 15.9317 2.02922 13.431 2.00003C10.9303 2.02922 8.58601 2.88453 6.54501 4.36981C4.38371 6.0123 2.82531 8.23419 2.08501 10.749C1.98418 11.1373 2.02894 11.543 2.21045 11.8955C2.39196 12.248 2.69777 12.528 3.06801 12.6932L5.12101 13.664C5.43851 13.8213 5.80183 13.8587 6.14901 13.7702C6.49619 13.6817 6.80496 13.4713 7.02801 13.1772C7.32168 12.7836 7.5532 12.3682 7.71701 11.936C7.50013 11.753 7.32174 11.5335 7.19201 11.2882C7.19201 11.2882 7.19201 11.2882 7.19101 11.2872C6.47432 10.1581 6.33851 8.82381 6.80401 7.64121C7.26951 6.45861 8.28801 5.58023 9.54401 5.24123C10.8 4.90222 12.114 5.14365 13.1259 5.88583C14.1378 6.62801 14.7423 7.79813 14.794 9.06421C14.794 9.06421 14.794 9.06421 14.795 9.06521C14.795 9.44421 14.717 9.81821 14.565 10.1652C14.565 10.1652 14.565 10.1652 14.564 10.1662C14.564 10.1662 14.564 10.1662 14.564 10.1672C15.176 11.64 15.029 13.284 14.195 14.612C14.195 14.612 14.195 14.612 14.195 14.613C14.195 14.613 14.194 14.613 14.194 14.614C13.36 15.942 11.983 16.821 10.471 16.983C10.471 16.983 10.471 16.983 10.47 16.983C10.47 16.983 10.469 16.983 10.469 16.983C10.469 16.983 10.468 16.983 10.468 16.983C8.95601 16.821 7.57901 15.942 6.74401 14.614C6.74401 14.613 6.74401 14.613 6.74301 14.613C6.74301 14.612 6.74301 14.612 6.74301 14.612C5.90901 13.284 5.76201 11.64 6.37401 10.1672C6.37401 10.1662 6.37401 10.1662 6.37401 10.1662C6.37501 10.1652 6.37501 10.1652 6.37501 10.1652C6.22301 9.81821 6.14501 9.44421 6.14501 9.06521C6.14501 9.06421 6.14501 9.06421 6.14501 9.06421C6.19668 7.79813 6.80119 6.62801 7.81307 5.88583C8.82495 5.14365 10.139 4.90222 11.395 5.24123C12.651 5.58023 13.6695 6.45861 14.135 7.64121C14.6005 8.82381 14.4647 10.1581 13.748 11.2872C13.748 11.2882 13.748 11.2882 13.748 11.2882C13.6183 11.5335 13.44 11.753 13.223 11.936C13.3868 12.3682 13.6183 12.7836 13.912 13.1772C14.1351 13.4713 14.4438 13.6817 14.791 13.7702C15.1382 13.8587 15.5015 13.8213 15.819 13.664L17.872 12.6932C18.2422 12.528 18.548 12.248 18.7295 11.8955C18.9111 11.543 18.9558 11.1373 18.855 10.749C18.1147 8.23419 16.5563 6.0123 14.395 4.36981L14.321 4.42381C14.7952 4.90112 15.192 5.45781 15.504 6.07581C15.6318 6.31295 15.8235 6.51676 16.061 6.66681C16.2985 6.81685 16.5741 6.90784 16.854 6.93181C17.728 6.99181 18.52 6.53881 18.941 5.81881C18.952 5.80081 18.963 5.78281 18.974 5.76481C19.444 5.02081 19.467 4.09181 19.017 3.36181C18.567 2.63181 17.714 2.22881 16.831 2.30281C15.948 2.37681 15.201 3.00381 14.931 3.84481C14.896 3.95881 14.878 4.07781 14.877 4.19881C14.877 4.54981 15.012 4.88781 15.257 5.14881C14.2887 4.51139 13.1948 4.16113 12.049 4.13381C12.049 4.13381 12.049 4.13381 12.048 4.13381C10.9022 4.16113 9.80831 4.51139 8.84001 5.14881C9.08501 4.88781 9.22001 4.54981 9.22001 4.19881C9.21901 4.07781 9.20101 3.95881 9.16601 3.84481C8.89601 3.00381 8.14901 2.37681 7.26601 2.30281C6.38301 2.22881 5.53001 2.63181 5.08001 3.36181C4.63001 4.09181 4.65301 5.02081 5.12301 5.76481C5.13401 5.78281 5.14501 5.80081 5.15601 5.81881C5.57701 6.53881 6.36901 6.99181 7.24301 6.93181C7.52292 6.90784 7.79851 6.81685 8.03601 6.66681C8.27352 6.51676 8.46524 6.31295 8.59301 6.07581C8.90501 5.45781 9.30179 4.90112 9.77601 4.42381L9.57101 4.36981C7.53001 2.88453 5.18571 2.02922 2.68501 2.00003C0.184316 2.02922 -2.15999 2.88453 -4.19999 4.36981C-6.36129 6.0123 -7.91969 8.23419 -8.65999 10.749C-8.76082 11.1373 -8.71606 11.543 -8.53455 11.8955C-8.35304 12.248 -8.04723 12.528 -7.67699 12.6932L-5.62399 13.664C-5.30649 13.8213 -4.94317 13.8587 -4.59599 13.7702C-4.24881 13.6817 -3.93904 13.4713 -3.71699 13.1772C-3.42332 12.7836 -3.1918 12.3682 -3.02799 11.936C-3.24487 11.753 -3.42326 11.5335 -3.55299 11.2882C-3.55299 11.2882 -3.55299 11.2882 -3.55399 11.2872C-4.27068 10.1581 -4.40649 8.82381 -3.94099 7.64121C-3.47549 6.45861 -2.45699 5.58023 -1.20099 5.24123C0.0549685 4.90222 1.36901 5.14365 2.38092 5.88583C3.39284 6.62801 3.99732 7.79813 4.04901 9.06421C4.04901 9.06421 4.04901 9.06421 4.04901 9.06521C4.04901 9.44421 3.97101 9.81821 3.81901 10.1652C3.81901 10.1652 3.81901 10.1652 3.81901 10.1662C3.81901 10.1662 3.81801 10.1662 3.81801 10.1672C4.43001 11.64 4.28301 13.284 3.44901 14.612C3.44901 14.612 3.44901 14.612 3.44801 14.613C3.44801 14.613 3.44801 14.613 3.44801 14.614C2.61401 15.942 1.23701 16.821 -0.274987 16.983C-0.274987 16.983 -0.275987 16.983 -0.275987 16.983C-0.275987 16.983 -0.276987 16.983 -0.276987 16.983C-0.277987 16.983 -0.277987 16.983 -0.277987 16.983C-1.78999 16.821 -3.16699 15.942 -4.00199 14.614C-4.00199 14.613 -4.00199 14.613 -4.00299 14.613C-4.00299 14.612 -4.00299 14.612 -4.00299 14.612C-4.83699 13.284 -4.98399 11.64 -4.37199 10.1672C-4.37199 10.1662 -4.37199 10.1662 -4.37099 10.1662C-4.37099 10.1652 -4.37099 10.1652 -4.37099 10.1652C-4.52299 9.81821 -4.60099 9.44421 -4.60099 9.06521C-4.60099 9.06421 -4.60099 9.06421 -4.60099 9.06421C-4.54932 7.79813 -3.94481 6.62801 -2.93293 5.88583C-1.92105 5.14365 -0.606987 4.90222 0.650013 5.24123C1.90601 5.58023 2.92451 6.45861 3.39001 7.64121C3.85551 8.82381 3.71971 10.1581 3.00301 11.2872C3.00301 11.2882 3.00301 11.2882 3.00201 11.2882C3.13174 11.5335 3.31013 11.753 3.52701 11.936C3.3632 12.3682 3.13168 12.7836 2.83801 13.1772C2.61496 13.4713 2.30619 13.6817 1.95901 13.7702C1.61183 13.8587 1.24851 13.8213 0.931013 13.664L-1.12199 12.6932C-1.49223 12.528 -1.79804 12.248 -1.97955 11.8955C-2.16106 11.543 -2.20582 11.1373 -2.10499 10.749C-1.36469 8.23419 0.193706 6.0123 2.35501 4.36981L2.42901 4.42381C1.95479 4.90112 1.55801 5.45781 1.24601 6.07581C1.11824 6.31295 0.926521 6.51676 0.688987 6.66681C0.451452 6.81685 0.175867 6.90784 -0.103987 6.93181C-0.977987 6.99181 -1.76999 6.53881 -2.19099 5.81881C-2.20199 5.80081 -2.21299 5.78281 -2.22399 5.76481C-2.69399 5.02081 -2.67099 4.09181 -2.22099 3.36181C-1.77099 2.63181 -0.917987 2.22881 -0.0349875 2.30281C0.848013 2.37681 1.59501 3.00381 1.86501 3.84481C1.90001 3.95881 1.91801 4.07781 1.91901 4.19881C1.91901 4.54981 1.78401 4.88781 1.53901 5.14881C2.50731 4.51139 3.60119 4.16113 4.74701 4.13381C4.74701 4.13381 4.74701 4.13381 4.74801 4.13381C5.89384 4.16113 6.98769 4.51139 7.95601 5.14881C7.71101 4.88781 7.57601 4.54981 7.57601 4.19881C7.57701 4.07781 7.59501 3.95881 7.63001 3.84481C7.90001 3.00381 8.64701 2.37681 9.53001 2.30281C10.413 2.22881 11.266 2.63181 11.716 3.36181C12.166 4.09181 12.143 5.02081 11.673 5.76481C11.662 5.78281 11.651 5.80081 11.64 5.81881C11.219 6.53881 10.427 6.99181 9.55301 6.93181C9.27309 6.90784 8.99751 6.81685 8.76001 6.66681C8.52248 6.51676 8.33076 6.31295 8.20301 6.07581C7.89101 5.45781 7.49421 4.90112 7.02001 4.42381L7.22501 4.36981Z"></path></svg>
                Login with Discord
            </button>
        </div>

        <!-- Main Content View -->
        <div id="main-view" class="hidden">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-700">
                <div id="user-profile" class="flex items-center mb-4 sm:mb-0">
                    <!-- User info will be injected here -->
                </div>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Logout
                </button>
            </header>

            <main>
                <h2 class="text-3xl font-bold mb-6 text-center">Team Dashboard</h2>
                
                <!-- Team Info Section -->
                <div id="team-info" class="bg-gray-800 rounded-xl p-6 shadow-lg">
                     <p id="no-team-message" class="text-center text-gray-400">You are not part of a team yet. Create or join one!</p>
                     <div id="team-details" class="hidden">
                        <h3 id="team-name" class="text-2xl font-bold text-center mb-4"></h3>
                        <div id="team-members" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Team members will be injected here -->
                        </div>
                     </div>
                </div>

            </main>
        </div>

    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        console.log("Script starting...");

        // --- ⚙️ CONFIGURATION - These will be replaced by GitHub Actions ---
        const firebaseConfig = {
            apiKey: "##FIREBASE_API_KEY##",
            authDomain: "##FIREBASE_AUTH_DOMAIN##",
            projectId: "##FIREBASE_PROJECT_ID##",
            storageBucket: "##FIREBASE_STORAGE_BUCKET##",
            messagingSenderId: "##FIREBASE_MESSAGING_SENDER_ID##",
            appId: "##FIREBASE_APP_ID##"
        };

        const DISCORD_CLIENT_ID = "##DISCORD_CLIENT_ID##"; 
        // --- END CONFIGURATION ---


        // --- UI ELEMENTS ---
        const loadingEl = document.getElementById('loading');
        const loginViewEl = document.getElementById('login-view');
        const mainViewEl = document.getElementById('main-view');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userProfileEl = document.getElementById('user-profile');
        const teamInfoEl = document.getElementById('team-info');
        const noTeamMessageEl = document.getElementById('no-team-message');
        const teamDetailsEl = document.getElementById('team-details');
        const teamNameEl = document.getElementById('team-name');
        const teamMembersEl = document.getElementById('team-members');


        // --- FIREBASE INITIALIZATION ---
        let app, auth, db;
        try {
            // Check if keys have been replaced. If not, don't even try to initialize.
            if (firebaseConfig.apiKey.startsWith("##")) {
                throw new Error("Firebase API keys have not been replaced by the build process.");
            }
            console.log("Firebase config looks okay, attempting to initialize...");
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("CRITICAL: Firebase initialization failed.", e);
            loadingEl.innerHTML = `<p class="text-red-400 text-lg">Error: Could not connect to services. Check browser console (F12) for details.</p>`;
        }


        // --- CORE LOGIC ---
        
        /**
         * Main function to initialize the app
         */
        function initializeAppLogic() {
            if (!auth) {
                console.error("Authentication service not available. Halting app logic.");
                return;
            }
            console.log("Setting up authentication listener...");
            // Listen for changes in Firebase authentication state
            onAuthStateChanged(auth, async (user) => {
                console.log("onAuthStateChanged triggered. User:", user ? user.uid : 'null');
                if (user) {
                    // User is signed in anonymously to Firebase
                    console.log("Firebase Anonymous User ID:", user.uid);
                    
                    const discordToken = getDiscordToken();
                    
                    if (discordToken) {
                        try {
                            const discordUser = await fetchDiscordUser(discordToken);
                            await saveUserToFirestore(user.uid, discordUser);
                            renderLoggedInState(discordUser);
                            // NOTE: In a real app, you would fetch and display team data here
                            // For now, we just show a "no team" message.
                            displayTeamInfo(null); 
                        } catch (error) {
                            console.error("Error fetching Discord user:", error);
                            clearSession();
                            renderLoggedOutState();
                        }
                    } else {
                        console.log("No Discord token found. Rendering logged out state.");
                        renderLoggedOutState();
                    }
                } else {
                    // User is not signed in to Firebase, attempt to sign in anonymously
                    console.log("No Firebase user. Attempting anonymous sign-in...");
                    signInAnonymously(auth).catch((error) => {
                        console.error("Anonymous sign-in failed:", error);
                        loadingEl.innerHTML = `<p class="text-red-400 text-lg">Error: Could not authenticate. Please check your connection and disable any ad-blockers.</p>`;
                    });
                }
            });
        }
        
        /**
         * Redirects the user to the Discord authorization page.
         */
        function handleLogin() {
            if (DISCORD_CLIENT_ID.startsWith("##")) {
                alert("The Discord Client ID has not been configured correctly. Please contact the site administrator.");
                return;
            }
            const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${redirectUri}&response_type=token&scope=identify`;
            window.location.href = authUrl;
        }

        /**
         * Checks the URL for a Discord access token after redirect.
         * @returns {string|null} The access token or null.
         */
        function getDiscordToken() {
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            const token = fragment.get('access_token');

            if (token) {
                // Store token and clean the URL
                localStorage.setItem('discord_token', token);
                window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
                return token;
            }
            
            // If no token in URL, check local storage
            return localStorage.getItem('discord_token');
        }

        /**
         * Fetches user data from the Discord API.
         * @param {string} token - The Discord access token.
         * @returns {Promise<object>} The Discord user object.
         */
        async function fetchDiscordUser(token) {
            const response = await fetch('https://discord.com/api/users/@me', {
                headers: {
                    authorization: `Bearer ${token}`,
                },
            });
            if (!response.ok) {
                // If the token is expired or invalid
                if (response.status === 401) {
                    throw new Error('Invalid or expired Discord token.');
                }
                throw new Error(`Discord API error: ${response.statusText}`);
            }
            return await response.json();
        }

        /**
         * Saves or updates the user's Discord profile in Firestore.
         * @param {string} firebaseUid - The user's anonymous Firebase UID.
         * @param {object} discordUser - The user data from Discord API.
         */
        async function saveUserToFirestore(firebaseUid, discordUser) {
            const userRef = doc(db, 'users', firebaseUid);
            const userData = {
                discordId: discordUser.id,
                username: discordUser.username,
                avatar: discordUser.avatar,
                lastLogin: new Date()
            };
            // Use setDoc with merge:true to create or update the document
            await setDoc(userRef, userData, { merge: true });
            console.log("User data saved to Firestore for UID:", firebaseUid);
        }

        /**
         * Clears the session by removing the token and reloading.
         */
        function clearSession() {
            localStorage.removeItem('discord_token');
            window.location.href = window.location.pathname + window.location.search; // Reload without the hash
        }
        
        
        // --- UI RENDERING ---

        /**
         * Shows the logged-in user interface.
         * @param {object} discordUser - The user object from Discord.
         */
        function renderLoggedInState(discordUser) {
            const avatarUrl = discordUser.avatar 
                ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`
                : 'https://cdn.discordapp.com/embed/avatars/0.png';

            userProfileEl.innerHTML = `
                <img src="${avatarUrl}" alt="${discordUser.username}'s avatar" class="w-12 h-12 rounded-full mr-4 border-2 border-gray-600">
                <div>
                    <p class="font-semibold text-lg">${discordUser.username}</p>
                    <p class="text-sm text-gray-400">#${discordUser.discriminator || '0000'}</p>
                </div>
            `;
            loadingEl.classList.add('hidden');
            loginViewEl.classList.add('hidden');
            mainViewEl.classList.remove('hidden');
        }

        /**
         * Shows the login button interface.
         */
        function renderLoggedOutState() {
            loadingEl.classList.add('hidden');
            mainViewEl.classList.add('hidden');
            loginViewEl.classList.remove('hidden');
        }

        /**
         * Displays team information or the 'no team' message.
         * @param {object|null} teamData - The team data object, or null.
         */
        function displayTeamInfo(teamData) {
            if (teamData) {
                teamNameEl.textContent = teamData.name;
                teamMembersEl.innerHTML = teamData.members.map(member => `
                    <div class="bg-gray-700 p-3 rounded-lg flex items-center">
                        <img src="${member.avatarUrl}" class="w-10 h-10 rounded-full mr-3">
                        <span class="font-medium">${member.username}</span>
                    </div>
                `).join('');

                noTeamMessageEl.classList.add('hidden');
                teamDetailsEl.classList.remove('hidden');
            } else {
                noTeamMessageEl.classList.remove('hidden');
                teamDetailsEl.classList.add('hidden');
            }
        }


        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', clearSession);

        // --- APP START ---
        initializeAppLogic();

    </script>
</body>
</html>

