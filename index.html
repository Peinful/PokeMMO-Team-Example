<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crow Syndicate - PokeMMO Team</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-image: url('images/background-sky.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .discord-btn {
            background-color: #5865F2;
            transition: background-color 0.3s ease;
        }
        .discord-btn:hover {
            background-color: #4752C4;
        }
        .loader {
            border-top-color: #5865F2;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .circular-container {
            position: relative;
            width: 350px;
            height: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
        }

        .center-logo {
            width: 140px;
            height: 140px;
            background-color: rgba(31, 41, 55, 0.8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid #4b5563;
            z-index: 10;
        }
        
        .center-logo img {
            width: 100px;
            height: 100px;
        }

        .icon-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(calc(360deg / 8 * var(--i)));
            pointer-events: none; /* Make the container div ignore clicks */
        }

        .icon-item a {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) rotate(0deg) translateY(-175px);
            width: 60px;
            height: 60px;
            background: #2b3748;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #9ca3af;
            font-size: 1.5rem;
            border: 2px solid #4b5563;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: auto; /* Re-enable clicks ONLY on the link */
        }
        
        .icon-item a .fa-solid {
             transform: rotate(calc(-360deg / 8 * var(--i))); /* Keep icon upright */
             transition: transform 0.3s ease;
        }

        .icon-item a:hover {
            background-color: #5865F2;
            color: #fff;
            border-color: #5865F2;
            box-shadow: 0 0 15px #5865F2;
        }
        
        .icon-item a:hover .fa-solid {
            transform: rotate(calc(-360deg / 8 * var(--i))) scale(1.2);
        }
        
        #flying-crows-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }

        .flying-crow {
            position: absolute;
            width: 200px;
            height: 176px;
            animation-name: fly-across;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            animation-fill-mode: backwards;
            opacity: 0;
        }

        @keyframes fly-across {
            0% {
                transform: translateX(100vw);
                opacity: 0;
            }
            5% {
                opacity: 1;
            }
            95% {
                opacity: 1;
            }
            100% {
                transform: translateX(-200px);
                opacity: 0;
            }
        }
        
        /* Shiny Dex Styles */
        #shiny-dex-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            z-index: 50;
        }
        .dex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }
        .dex-entry {
            background-color: #374151;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            border: 2px solid transparent;
        }
        .dex-entry:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #5865F2;
        }
        .dex-entry.pending {
            border-color: #FBBF24; /* Yellow for pending */
        }
        .dex-entry.captured, .dex-entry.pending {
            cursor: not-allowed;
        }

        .dex-entry img {
            width: 96px;
            height: 96px;
            margin: 0 auto;
            transition: filter 0.3s ease;
        }
        .dex-entry .sprite {
            filter: brightness(0);
        }
        .dex-entry.captured .sprite {
            filter: brightness(1);
        }
        .dex-entry.pending .sprite {
            filter: brightness(1) grayscale(50%);
        }

    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="flying-crows-container"></div>

    <div id="app" class="w-full max-w-5xl mx-auto" style="position: relative; z-index: 5;">
        
        <!-- Loading State -->
        <div id="loading" class="text-center">
             <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
             <p class="text-lg text-gray-400">Loading your PokeMMO Hub...</p>
        </div>
        
        <!-- Landing Page View -->
        <div id="landing-view" class="hidden flex-col items-center text-center">
             <div class="circular-container mb-12">
                <div class="center-logo">
                    <img src="images/crow.png" alt="Crow Syndicate Logo">
                </div>
                <!-- Icons will be positioned around the logo -->
                <div class="icon-item" style="--i: 0;"><a data-page="shiny-dex" data-tooltip="Shiny Dex"><i class="fa-solid fa-wand-magic-sparkles"></i></a></div>
                <div class="icon-item" style="--i: 1;"><a data-page="about-us" data-tooltip="About Us"><i class="fa-solid fa-circle-info"></i></a></div>
                <div class="icon-item" style="--i: 2;"><a data-page="members" data-tooltip="Members"><i class="fa-solid fa-users"></i></a></div>
                <div class="icon-item" style="--i: 3;"><a data-page="recruitment" data-tooltip="Recruitment"><i class="fa-solid fa-user-plus"></i></a></div>
                <div class="icon-item" style="--i: 4;"><a data-page="shiny-hall" data-tooltip="Shiny Hall"><i class="fa-solid fa-star"></i></a></div>
                <div class="icon-item" style="--i: 5;"><a data-page="tournaments" data-tooltip="Tournaments"><i class="fa-solid fa-trophy"></i></a></div>
                <div class="icon-item" style="--i: 6;"><a data-page="bounties" data-tooltip="Bounties"><i class="fa-solid fa-crosshairs"></i></a></div>
                <div class="icon-item" style="--i: 7;"><a data-page="gallery" data-tooltip="Gallery"><i class="fa-solid fa-images"></i></a></div>
             </div>
             <h1 class="text-6xl font-bold mb-4 text-white drop-shadow-lg" style="text-shadow: 2px 2px 4px #000000;">Crow Syndicate</h1>
             <p class="text-gray-200 mb-8 max-w-md bg-black bg-opacity-50 p-2 rounded-md">A PokeMMO team focused on competitive play, community, and strategy. Log in to join the ranks.</p>
             
             <div id="auth-buttons">
                <!-- Login/Logout buttons will be injected here -->
             </div>
        </div>

        <!-- Members / Dashboard View -->
        <div id="dashboard-view" class="hidden w-full">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-700">
                <button class="back-btn text-gray-400 hover:text-white transition-colors mb-4 sm:mb-0"><i class="fa-solid fa-arrow-left mr-2"></i> Back to Home</button>
                <div id="user-profile" class="flex items-center">
                    <!-- User info will be injected here -->
                </div>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Logout
                </button>
            </header>

            <main class="bg-gray-800 rounded-xl p-6 shadow-lg">
                <h2 id="team-name" class="text-3xl font-bold mb-6 text-center"></h2>
                <div id="team-members" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Team members will be injected here -->
                </div>
                <div id="join-team-container" class="text-center mt-8 hidden">
                     <p class="text-gray-400 mb-4">You are not yet a member of the syndicate.</p>
                     <button id="join-team-btn" class="discord-btn text-white font-bold py-3 px-6 rounded-lg text-lg">
                        Join Crow Syndicate
                     </button>
                </div>
            </main>
        </div>
        
        <!-- Generic Page View -->
        <div id="page-view" class="hidden w-full">
             <header class="flex justify-start items-center mb-8 pb-4 border-b border-gray-700">
                <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back to Home</button>
             </header>
             <main class="bg-gray-800 rounded-xl p-8 shadow-lg text-center">
                <h2 id="page-title" class="text-4xl font-bold mb-6"></h2>
                <div id="page-content" class="text-gray-300">
                    <p>Content for this section is coming soon!</p>
                </div>
             </main>
        </div>

    </div>

    <!-- Shiny Dex View -->
    <div id="shiny-dex-view" class="hidden p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <button class="back-btn text-gray-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back to Home</button>
            <h1 class="text-3xl font-bold text-center">Shiny Dex</h1>
            <div id="dex-counter" class="text-lg text-gray-400 font-semibold">0 / 0</div>
        </header>
        <main id="dex-grid" class="dex-grid">
            <!-- Pokémon entries will be injected here -->
        </main>
    </div>
    
    <!-- Verification Modal -->
    <div id="verification-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60]">
        <div class="bg-gray-800 rounded-lg p-8 w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="verify-pokemon-name" class="text-2xl font-bold">Verify Shiny Capture</h2>
                 <img id="verify-pokemon-sprite" src="" class="w-16 h-16">
            </div>
            <p class="text-gray-400 mb-6">Submit the details of your capture for verification by staff.</p>
            <form id="verification-form">
                <input type="hidden" id="verify-pokemon-id">
                <div class="mb-4">
                    <label for="verify-discord-user" class="block text-sm font-medium text-gray-300 mb-1">Discord Username</label>
                    <input type="text" id="verify-discord-user" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" readonly>
                </div>
                <div class="mb-4">
                    <label for="verify-ingame-name" class="block text-sm font-medium text-gray-300 mb-1">In-game Name</label>
                    <input type="text" id="verify-ingame-name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" required>
                </div>
                <div class="mb-4">
                    <label for="verify-date" class="block text-sm font-medium text-gray-300 mb-1">Date Captured</label>
                    <input type="date" id="verify-date" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" required>
                </div>
                <div class="mb-4">
                    <label for="verify-encounters" class="block text-sm font-medium text-gray-300 mb-1">Number of Encounters (Optional)</label>
                    <input type="number" id="verify-encounters" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" min="0">
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-verification-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="submit-verification-btn" class="discord-btn text-white font-bold py-2 px-4 rounded-lg">Submit for Verification</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- ⚙️ CONFIGURATION - These will be replaced by GitHub Actions ---
        const firebaseConfig = {
            apiKey: "##FIREBASE_API_KEY##",
            authDomain: "##FIREBASE_AUTH_DOMAIN##",
            projectId: "##FIREBASE_PROJECT_ID##",
            storageBucket: "##FIREBASE_STORAGE_BUCKET##",
            messagingSenderId: "##FIREBASE_MESSAGING_SENDER_ID##",
            appId: "##FIREBASE_APP_ID##"
        };
        const DISCORD_CLIENT_ID = "##DISCORD_CLIENT_ID##"; 
        const TEAM_ID = "crow-syndicate"; // Hardcoded team ID for now
        const POKEMON_COUNT = 649;
        // --- END CONFIGURATION ---

        // --- STATE ---
        let currentUser = null;
        let discordUser = null;
        let pokemonData = [];
        let userDexData = new Set();
        let userPendingData = new Set();
        let isDexLoaded = false;

        // --- UI ELEMENTS ---
        const appViews = {
            loading: document.getElementById('loading'),
            landing: document.getElementById('landing-view'),
            dashboard: document.getElementById('dashboard-view'),
            page: document.getElementById('page-view'),
            shinyDex: document.getElementById('shiny-dex-view')
        };
        
        const authButtonsContainer = document.getElementById('auth-buttons');
        const userProfileEl = document.getElementById('user-profile');
        const teamNameEl = document.getElementById('team-name');
        const teamMembersEl = document.getElementById('team-members');
        const joinTeamContainer = document.getElementById('join-team-container');
        const joinTeamBtn = document.getElementById('join-team-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const pageTitleEl = document.getElementById('page-title');
        const pageContentEl = document.getElementById('page-content');
        const iconLinks = document.querySelectorAll('.icon-item a');
        const backBtns = document.querySelectorAll('.back-btn');
        const dexGridEl = document.getElementById('dex-grid');
        const dexCounterEl = document.getElementById('dex-counter');

        // Verification Modal Elements
        const verificationModal = document.getElementById('verification-modal');
        const verificationForm = document.getElementById('verification-form');
        const cancelVerificationBtn = document.getElementById('cancel-verification-btn');
        const verifyPokemonIdInput = document.getElementById('verify-pokemon-id');
        const verifyPokemonNameEl = document.getElementById('verify-pokemon-name');
        const verifyPokemonSpriteEl = document.getElementById('verify-pokemon-sprite');
        const verifyDiscordUserInput = document.getElementById('verify-discord-user');


        // --- FIREBASE INITIALIZATION ---
        let app, auth, db;
        try {
            if (firebaseConfig.apiKey.startsWith("##")) throw new Error("Firebase keys not replaced.");
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("CRITICAL: Firebase initialization failed.", e);
            appViews.loading.innerHTML = `<p class="text-red-400 text-lg">Error: Could not connect to services. Check console (F12).</p>`;
        }
        
        // --- VISUAL EFFECTS ---
        function createFlyingCrows(numberOfCrows) {
            const container = document.getElementById('flying-crows-container');
            if (!container) return;
            for (let i = 0; i < numberOfCrows; i++) {
                const crow = document.createElement('img');
                crow.src = 'images/flyingcrows.gif';
                crow.className = 'flying-crow';
                crow.style.top = `${Math.random() * 80}vh`;
                crow.style.animationDuration = `${10 + Math.random() * 10}s`;
                crow.style.animationDelay = `${Math.random() * 15}s`;
                container.appendChild(crow);
            }
        }

        // --- NAVIGATION & VIEW MANAGEMENT ---
        function showView(viewName) {
            document.body.style.overflow = (viewName === 'shinyDex') ? 'auto' : 'hidden';
            Object.values(appViews).forEach(view => view.classList.add('hidden'));
            if (appViews[viewName]) {
                 appViews[viewName].classList.remove('hidden');
                 if(viewName === 'landing') appViews[viewName].classList.add('flex');
            }
        }

        // --- CORE LOGIC ---
        function initializeAppLogic() {
            if (!auth) return;
            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user) {
                    const discordToken = getDiscordToken();
                    if (discordToken) {
                        try {
                            discordUser = await fetchDiscordUser(discordToken);
                            await saveUserToFirestore(user.uid, discordUser);
                            renderAuthButtons();
                            loadTeamData();
                            // Load both captured and pending data for the dex
                            await Promise.all([loadUserDexData(), loadPendingVerifications()]);
                        } catch (error) {
                            console.error("Error with Discord user:", error);
                            clearSession(true);
                        }
                    } else {
                        renderLoggedOutState();
                    }
                } else {
                    signInAnonymously(auth).catch(console.error);
                }
            });
        }
        
        function handleLogin() {
            if (DISCORD_CLIENT_ID.startsWith("##")) {
                alert("Discord Client ID not configured.");
                return;
            }
            const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${redirectUri}&response_type=token&scope=identify`;
            window.location.href = authUrl;
        }

        function getDiscordToken() {
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            const token = fragment.get('access_token');
            if (token) {
                localStorage.setItem('discord_token', token);
                window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
                return token;
            }
            return localStorage.getItem('discord_token');
        }

        async function fetchDiscordUser(token) {
            const response = await fetch('https://discord.com/api/users/@me', {
                headers: { authorization: `Bearer ${token}` },
            });
            if (!response.ok) {
                if (response.status === 401) throw new Error('Invalid Discord token.');
                throw new Error(`Discord API error: ${response.statusText}`);
            }
            return await response.json();
        }

        async function saveUserToFirestore(firebaseUid, dUser) {
            const userRef = doc(db, 'users', firebaseUid);
            const userData = {
                discordId: dUser.id,
                username: dUser.username,
                avatar: dUser.avatar,
                lastLogin: new Date()
            };
            await setDoc(userRef, userData, { merge: true });
        }

        async function loadTeamData() {
            const teamRef = doc(db, 'teams', TEAM_ID);
            const teamSnap = await getDoc(teamRef);

            if (!teamSnap.exists()) {
                console.error("Team document does not exist!");
                teamNameEl.textContent = "Team Not Found";
                return;
            }
            
            const teamData = teamSnap.data();
            renderTeamInfo(teamData);
            
            if (discordUser) {
                renderDashboardHeader(discordUser);
                const isMember = teamData.members.some(member => member.discordId === discordUser.id);
                joinTeamContainer.classList.toggle('hidden', isMember);
            }
        }
        
        async function handleJoinTeam() {
            if (!discordUser) return;
            joinTeamBtn.disabled = true;
            joinTeamBtn.textContent = "Joining...";
            const teamRef = doc(db, 'teams', TEAM_ID);
            const newMember = { discordId: discordUser.id, username: discordUser.username, avatar: discordUser.avatar };
            try {
                await updateDoc(teamRef, { members: arrayUnion(newMember) });
                loadTeamData();
            } catch (error) {
                console.error("Failed to join team:", error);
                alert("There was an error trying to join the team.");
                joinTeamBtn.disabled = false;
                joinTeamBtn.textContent = "Join Crow Syndicate";
            }
        }

        function clearSession(isError = false) {
            localStorage.removeItem('discord_token');
            discordUser = null;
            if (!isError) {
                window.location.href = window.location.pathname + window.location.search;
            } else {
                 renderLoggedOutState();
            }
        }

        // --- SHINY DEX LOGIC ---
        async function showShinyDex() {
            if (!discordUser) {
                handleLogin();
                return;
            }
            if (!isDexLoaded) {
                dexGridEl.innerHTML = `<div class="col-span-full text-center"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div><p>Loading Pokémon...</p></div>`;
                showView('shinyDex');
                await fetchPokemonData();
                renderDexGrid();
                isDexLoaded = true;
            } else {
                renderDexGrid();
                showView('shinyDex');
            }
        }

        async function fetchPokemonData() {
            if(pokemonData.length > 0) return; // Don't re-fetch if already loaded
            try {
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon?limit=${POKEMON_COUNT}`);
                const data = await response.json();
                pokemonData = data.results.map((p, index) => ({
                    id: index + 1,
                    name: p.name.charAt(0).toUpperCase() + p.name.slice(1),
                    sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${index + 1}.png`
                }));
            } catch (error) {
                console.error("Failed to fetch Pokémon data:", error);
                dexGridEl.innerHTML = `<p class="text-red-400 text-center col-span-full">Could not load Pokémon data.</p>`;
            }
        }

        async function loadUserDexData() {
            if (!currentUser) return;
            const dexRef = doc(db, `users/${currentUser.uid}/dex/shiny-dex`);
            const dexSnap = await getDoc(dexRef);
            if (dexSnap.exists()) {
                userDexData = new Set(dexSnap.data().captured || []);
            } else {
                userDexData = new Set();
            }
        }
        
        async function loadPendingVerifications() {
            if (!currentUser) return;
            userPendingData = new Set();
            const q = query(collection(db, "verification-requests"), where("userId", "==", currentUser.uid), where("status", "==", "pending"));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                userPendingData.add(doc.data().pokemonId);
            });
        }


        function renderDexGrid() {
            dexCounterEl.textContent = `${userDexData.size} / ${POKEMON_COUNT}`;
            dexGridEl.innerHTML = pokemonData.map(p => {
                const isCaptured = userDexData.has(p.id);
                const isPending = userPendingData.has(p.id);
                let statusClass = '';
                if (isCaptured) statusClass = 'captured';
                else if (isPending) statusClass = 'pending';

                return `
                <div class="dex-entry ${statusClass}" data-id="${p.id}">
                    <img src="${p.sprite}" alt="${p.name}" class="sprite">
                    <p class="text-sm font-medium mt-1">#${String(p.id).padStart(3, '0')}</p>
                    <p class="text-xs text-gray-400">${p.name}</p>
                </div>
            `}).join('');

            document.querySelectorAll('.dex-entry').forEach(entry => {
                entry.addEventListener('click', handleDexEntryClick);
            });
        }

        function handleDexEntryClick(e) {
            const entry = e.currentTarget;
            const pokemonId = parseInt(entry.dataset.id, 10);
            
            // Prevent action if already captured or pending
            if (userDexData.has(pokemonId) || userPendingData.has(pokemonId)) {
                return;
            }

            const pokemon = pokemonData.find(p => p.id === pokemonId);
            if(pokemon) {
                openVerificationModal(pokemon);
            }
        }

        function openVerificationModal(pokemon) {
            verifyPokemonIdInput.value = pokemon.id;
            verifyPokemonNameEl.textContent = `Verify: ${pokemon.name}`;
            verifyPokemonSpriteEl.src = pokemon.sprite;
            verifyDiscordUserInput.value = discordUser.username;
            verificationForm.reset(); // Clear previous entries
            verificationModal.classList.remove('hidden');
        }

        function closeVerificationModal() {
            verificationModal.classList.add('hidden');
        }

        async function handleVerificationSubmit(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const pokemonId = parseInt(verifyPokemonIdInput.value, 10);
            const pokemon = pokemonData.find(p => p.id === pokemonId);

            const requestData = {
                userId: currentUser.uid,
                discordUsername: discordUser.username,
                discordId: discordUser.id,
                pokemonId: pokemonId,
                pokemonName: pokemon.name,
                inGameName: e.target['verify-ingame-name'].value,
                dateCaptured: e.target['verify-date'].value,
                encounters: e.target['verify-encounters'].value || null,
                status: 'pending',
                submittedAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "verification-requests"), requestData);
                userPendingData.add(pokemonId);
                renderDexGrid(); // Re-render to show pending status
                closeVerificationModal();
            } catch (error) {
                console.error("Error submitting verification:", error);
                alert("Failed to submit verification. Please try again.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit for Verification';
            }
        }
        
        // --- UI RENDERING ---
        function renderAuthButtons() {
            if (discordUser) {
                const avatarUrl = discordUser.avatar ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png';
                authButtonsContainer.innerHTML = `
                    <div class="flex items-center justify-center">
                        <img src="${avatarUrl}" class="w-10 h-10 rounded-full mr-4">
                        <span class="font-semibold">${discordUser.username}</span>
                    </div>
                `;
            } else {
                 authButtonsContainer.innerHTML = `
                    <button id="login-btn" class="discord-btn text-white font-bold py-3 px-6 rounded-lg inline-flex items-center text-lg">
                        <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.36981C18.276 2.88453 15.9317 2.02922 13.431 2.00003C10.9303 2.02922 8.58601 2.88453 6.54501 4.36981C4.38371 6.0123 2.82531 8.23419 2.08501 10.749C1.98418 11.1373 2.02894 11.543 2.21045 11.8955C2.39196 12.248 2.69777 12.528 3.06801 12.6932L5.12101 13.664C5.43851 13.8213 5.80183 13.8587 6.14901 13.7702C6.49619 13.6817 6.80496 13.4713 7.02801 13.1772C7.32168 12.7836 7.5532 12.3682 7.71701 11.936C7.50013 11.753 7.32174 11.5335 7.19201 11.2882C6.47432 10.1581 6.33851 8.82381 6.80401 7.64121C7.26951 6.45861 8.28801 5.58023 9.54401 5.24123C10.8 4.90222 12.114 5.14365 13.1259 5.88583C14.1378 6.62801 14.7423 7.79813 14.794 9.06421C14.795 9.44421 14.717 9.81821 14.565 10.1652C15.176 11.64 15.029 13.284 14.195 14.612C13.36 15.942 11.983 16.821 10.471 16.983C9.07929 17.1439 7.64134 16.592 6.54501 15.4812V15.4812C7.45266 16.2088 8.56342 16.6669 9.76101 16.8012C11.536 17.0212 13.313 16.4802 14.671 15.3042C15.2217 14.8113 15.6813 14.2312 16.033 13.5932C16.293 14.2492 16.69 14.8512 17.206 15.3612C18.151 16.2152 19.399 16.7002 20.702 16.7002C20.999 16.6992 21.285 16.6092 21.522 16.4422C21.93 16.1582 22.1 15.6512 21.936 15.1752C21.432 13.6232 20.455 12.2922 19.14 11.4312C18.8182 11.2036 18.4485 11.0493 18.056 10.9812C18.441 10.4852 18.732 9.91421 18.911 9.29421C19.131 8.52821 19.131 7.71221 18.911 6.94621C18.643 5.98621 18.016 5.16021 17.14 4.60021C16.264 4.04021 15.194 3.80021 14.13 3.94521C14.542 3.32821 15.042 2.79321 15.61 2.36121C16.179 1.92921 16.809 1.60521 17.472 1.40121L17.58 0.0712128C17.348 -0.0167872 17.102 -0.0577872 16.858 0.0242128C14.821 0.443213 12.971 1.47221 11.525 2.99821C10.795 3.75021 10.199 4.61521 9.77601 5.56021C10.451 5.45221 11.14 5.43321 11.823 5.50521C12.871 5.61521 13.841 6.06221 14.551 6.77221C15.261 7.48221 15.665 8.40621 15.665 9.38021C15.665 10.3542 15.261 11.2782 14.551 11.9882C13.841 12.6982 12.871 13.1452 11.823 13.2552C11.14 13.3272 10.451 13.3082 9.77601 13.2002C9.55701 14.0372 9.14101 14.8112 8.55901 15.4812L8.55901 15.4822C7.65136 16.2098 6.5406 16.6679 5.34301 16.8022C4.14542 16.9365 2.95379 16.7374 1.90501 16.2332C1.7235 15.8797 1.62267 15.484 1.61101 15.0822C2.17549 13.8076 3.12033 12.7834 4.31901 12.1642C3.59601 10.8802 3.32101 9.42321 3.54501 7.99421C3.76901 6.56521 4.47901 5.25321 5.56101 4.29521C7.45855 2.59972 9.94334 1.66421 12.5 1.69321H12.501C15.0577 1.66421 17.5424 2.59972 19.44 4.29521C20.522 5.25321 21.232 6.56521 21.456 7.99421C21.68 9.42321 21.405 10.8802 20.682 12.1632C21.8807 12.7834 22.8255 13.8076 23.389 15.0782C23.3773 15.484 23.2765 15.8797 23.096 16.2322C22.0462 16.7374 20.8546 16.9365 19.657 16.8022C18.4594 16.6679 17.3486 16.2098 16.441 15.4822C15.859 14.8112 15.443 14.0372 15.224 13.2002C14.549 13.3082 13.86 13.3272 13.177 13.2552C12.129 13.1452 11.159 12.6982 10.449 11.9882C9.73901 11.2782 9.33501 10.3542 9.33501 9.38021C9.33501 8.40621 9.73901 7.48221 10.449 6.77221C11.159 6.06221 12.129 5.61521 13.177 5.50521C13.86 5.43321 14.549 5.45221 15.224 5.56021C14.801 4.61521 14.205 3.75021 13.475 2.99821C12.029 1.47221 10.179 0.443213 8.14201 0.0242128C7.89801 -0.0577872 7.65201 -0.0167872 7.42101 0.0712128L7.52801 1.40121C8.19101 1.60521 8.82101 1.92921 9.39001 2.36121C9.95801 2.79321 10.458 3.32821 10.873 3.94521C9.80601 3.80021 8.73601 4.04021 7.86001 4.60021C6.98401 5.16021 6.35701 5.98621 6.08901 6.94621C5.86901 7.71221 5.86901 8.52821 6.08901 9.29421C6.26801 9.91421 6.55901 10.4852 6.94401 10.9812C6.55153 11.0493 6.18182 11.2036 5.86001 11.4312C4.54501 12.2922 3.56801 13.6232 3.06401 15.1752C2.90001 15.6512 3.07001 16.1582 3.47801 16.4422C3.71501 16.6092 4.00101 16.6992 4.29501 16.7002C5.60101 16.7002 6.84901 16.2152 7.79401 15.3612C8.31001 14.8512 8.70701 14.2492 8.96701 13.5932C9.31869 14.2312 9.77831 14.8113 10.329 15.3042C11.687 16.4802 13.464 17.0212 15.239 16.8012C16.4366 16.6669 17.5474 16.2088 18.455 15.4812C19.4587 16.592 20.9207 17.1439 22.312 16.983C23.824 16.821 25.201 15.942 26.035 14.614C26.87 13.284 27.023 11.64 26.411 10.1672C26.259 9.81821 26.181 9.44421 26.181 9.06521C26.2327 7.79813 26.8372 6.62801 27.8491 5.88583C28.861 5.14365 30.175 4.90222 31.431 5.24123C32.687 5.58023 33.7055 6.45861 34.171 7.64121C34.6365 8.82381 34.5007 10.1581 33.784 11.2872C33.6543 11.5335 33.4759 11.753 33.259 11.936C33.4228 12.3682 33.6543 12.7836 33.948 13.1772C34.171 13.4713 34.4798 13.6817 34.827 13.7702C35.1742 13.8587 35.5375 13.8213 35.855 13.664L37.908 12.6932C38.2782 12.528 38.584 12.248 38.7655 11.8955C38.9471 11.543 38.9918 11.1373 38.891 10.749C38.1507 8.23419 36.5923 6.0123 34.431 4.36981C32.39 2.88453 30.0457 2.02922 27.545 2.00003C25.0443 2.02922 22.699 2.88453 20.658 4.36981L20.317 4.36981Z" /></svg>
                        Login with Discord
                    </button>`;
                 document.getElementById('login-btn').addEventListener('click', handleLogin);
            }
        }
        
        function renderLoggedOutState() {
            showView('landing');
            renderAuthButtons();
        }

        function renderDashboardHeader(dUser) {
            const avatarUrl = dUser.avatar 
                ? `https://cdn.discordapp.com/avatars/${dUser.id}/${dUser.avatar}.png`
                : 'https://cdn.discordapp.com/embed/avatars/0.png';

            userProfileEl.innerHTML = `
                <img src="${avatarUrl}" alt="${dUser.username}'s avatar" class="w-12 h-12 rounded-full mr-4 border-2 border-gray-600">
                <div>
                    <p class="font-semibold text-lg">${dUser.username}</p>
                </div>`;
        }
        
        function renderTeamInfo(teamData) {
            teamNameEl.textContent = teamData.name;
            if (teamData.members && teamData.members.length > 0) {
                 teamMembersEl.innerHTML = teamData.members.map(member => {
                    const avatarUrl = member.avatar 
                        ? `https://cdn.discordapp.com/avatars/${member.discordId}/${member.avatar}.png`
                        : 'https://cdn.discordapp.com/embed/avatars/0.png';
                    return `
                        <div class="bg-gray-700 p-3 rounded-lg flex items-center shadow-md">
                            <img src="${avatarUrl}" class="w-10 h-10 rounded-full mr-3">
                            <span class="font-medium">${member.username}</span>
                        </div>
                    `;
                 }).join('');
            } else {
                teamMembersEl.innerHTML = `<p class="text-center text-gray-400 col-span-full">This team has no members yet.</p>`;
            }
        }

        // --- EVENT LISTENERS ---
        logoutBtn.addEventListener('click', () => clearSession(false));
        joinTeamBtn.addEventListener('click', handleJoinTeam);
        
        iconLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.dataset.page;
                
                if (page === 'shiny-dex') {
                    showShinyDex();
                } else if (page === 'members') {
                    if (discordUser) {
                        showView('dashboard');
                    } else {
                        handleLogin();
                    }
                } else {
                    pageTitleEl.textContent = link.dataset.tooltip;
                    pageContentEl.innerHTML = `<p>Content for the ${link.dataset.tooltip} section is coming soon!</p>`;
                    showView('page');
                }
            });
        });

        backBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // If closing dex, keep body scrollable for landing page
                if (!appViews.shinyDex.classList.contains('hidden')) {
                     document.body.style.overflow = 'hidden';
                }
                showView('landing');
            });
        });

        verificationForm.addEventListener('submit', handleVerificationSubmit);
        cancelVerificationBtn.addEventListener('click', closeVerificationModal);

        // --- APP START ---
        showView('loading');
        createFlyingCrows(5); // Add 5 flying crows to the scene
        initializeAppLogic();
    </script>
</body>
</html>


